<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Novellium Builder</title>
  <link rel="icon" type="image/png" href="./NovelliumLogo/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="./NovelliumLogo/favicon.svg" />
  <link rel="shortcut icon" href="./NovelliumLogo/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="./NovelliumLogo/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Novellium" />
  <link rel="manifest" href="./NovelliumLogo/site.webmanifest" />
  <link rel="stylesheet" href="styles.css?v=4.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    .builder-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
    }
    
    .builder-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .builder-sidebar {
      width: 250px;
      background: rgba(0, 0, 0, 0.5);
      border-right: 2px solid rgba(255, 215, 0, 0.3);
      padding: 20px;
      overflow-y: auto;
    }

    .builder-main {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    .builder-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .builder-nav li {
      padding: 12px 15px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .builder-nav li:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: #ffd700;
      transform: translateX(5px);
    }

    .builder-nav li.active {
      background: rgba(255, 215, 0, 0.2);
      border-left-color: #ffd700;
    }

    .builder-section {
      display: none;
      animation: fadeIn 0.3s;
    }

    .builder-section.active {
      display: block;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      color: #ffd700;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #ffd700;
      background: rgba(255, 255, 255, 0.15);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .form-hint {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #1a1a2e;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-danger {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 2px solid #ff6b6b;
    }

    .btn-danger:hover {
      background: rgba(255, 107, 107, 0.4);
    }

    /* Mode selection buttons */
    .import-mode-btn, .deploy-mode-btn {
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
    }

    .import-mode-btn.selected, .deploy-mode-btn.selected {
      background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
      color: #1a1a2e !important;
      border-color: #ffd700 !important;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
    }

    .import-mode-btn:hover, .deploy-mode-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(255, 255, 255, 0.1);
    }

    .section-header {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
    }

    .section-header h2 {
      color: #ffd700;
      margin: 0 0 5px 0;
      font-size: 28px;
    }

    .section-header p {
      color: #999;
      margin: 0;
      font-size: 14px;
    }

    .list-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .list-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .list-item-info h4 {
      margin: 0 0 5px 0;
      color: #ffd700;
    }

    .list-item-info p {
      margin: 0;
      font-size: 12px;
      color: #999;
    }

    .list-item-actions button {
      margin-left: 8px;
      padding: 6px 12px;
      font-size: 12px;
    }

    .event-builder {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 215, 0, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .event-type-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .event-type-btn {
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .event-type-btn:hover,
    .event-type-btn.selected {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.1);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .top-bar {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px 30px;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h1 {
      margin: 0;
      font-size: 24px;
      color: #ffd700;
    }

    .top-bar-actions {
      display: flex;
      gap: 10px;
    }

    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .mode-toggle label {
      color: #ffd700;
      font-size: 14px;
      margin: 0;
    }

    .mode-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-switch.active {
      background: #ffd700;
    }

    .mode-switch-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .mode-switch.active .mode-switch-thumb {
      left: 28px;
    }

    .json-editor-container {
      display: none;
      height: calc(100vh - 200px);
    }

    .json-editor-container.active {
      display: block;
    }

    .json-editor {
      width: 100%;
      height: 100%;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 8px;
      color: #ffd700;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: none;
    }

    .json-editor:focus {
      outline: none;
      border-color: #ffd700;
    }

    .json-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
      padding-bottom: 10px;
    }

    .json-tab {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px 8px 0 0;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .json-tab:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .json-tab.active {
      background: rgba(255, 215, 0, 0.2);
      border-color: #ffd700;
      color: #ffd700;
    }
  </style>
</head>
<body>
  <div class="builder-container">
    <!-- Navbar will be loaded here -->
    <div id="navbar-container" style="position: sticky; top: 0; z-index: 1000;"></div>
    
    <!-- Builder Content (Sidebar + Main) -->
    <div class="builder-content">
    <!-- Sidebar Navigation -->
    <div class="builder-sidebar">
      <h2 style="color: #ffd700; margin-top: 0;">üéÆ Builder</h2>
      <ul class="builder-nav">
        <li class="nav-item active" data-section="howto">‚ùì How-To Guide</li>
        <li class="nav-item" data-section="project">üìÅ Project Info</li>
        <li class="nav-item" data-section="characters">üë§ Characters</li>
        <li class="nav-item" data-section="events">üìñ Story Events</li>
        <li class="nav-item" data-section="assets">üñºÔ∏è Assets</li>
        <li class="nav-item" data-section="export">üì¶ Export/Build</li>
        <li class="nav-item" data-section="import">üì• Import & Deploy</li>
      </ul>
    </div>

    <!-- Main Content Area -->
    <div style="flex: 1; display: flex; flex-direction: column;">
      <!-- Builder Toolbar -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);">
        <div class="mode-toggle">
          <label>Form Mode</label>
          <div class="mode-switch" id="mode-switch">
            <div class="mode-switch-thumb"></div>
          </div>
          <label>JSON Editor</label>
        </div>
        <button class="btn btn-primary" id="btn-save-project">üíæ Save Project</button>
      </div>
      
      <div class="builder-main">
        <!-- JSON Editor Mode -->
        <div class="json-editor-container" id="json-editor-container">
          <div class="section-header">
            <h2 id="json-editor-title">üìù JSON Editor</h2>
            <p id="json-editor-desc">Edit your project data directly in JSON format</p>
          </div>

          <textarea class="json-editor" id="json-editor" spellcheck="false"></textarea>
          
          <div style="margin-top: 20px;">
            <button class="btn btn-primary" id="btn-apply-json">‚úÖ Apply Changes</button>
            <button class="btn btn-secondary" id="btn-format-json">üé® Format JSON</button>
            <button class="btn btn-secondary" id="btn-validate-json">‚úîÔ∏è Validate JSON</button>
          </div>
        </div>

        <!-- Form Mode (existing sections) -->
        <div id="form-mode-container">
        <!-- How-To Guide Section -->
        <div class="builder-section active" id="section-howto">
          <div class="section-header">
            <h2>‚ùì How-To Guide</h2>
            <p>Learn how the Novellium engine works</p>
          </div>

          <div style="background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 10px; line-height: 1.8;">
            <h3 style="color: #ffd700; margin-top: 0;">üéØ Engine Overview</h3>
            <p>Novellium is an event-driven visual novel engine. Your story flows through <strong>Events</strong> that display text, show characters, play dialogue, and offer choices.</p>

            <h3 style="color: #ffd700; margin-top: 30px;">üìñ Story Events</h3>
            <p>Events are the core building blocks of your story. Each event has:</p>
            <ul style="margin-left: 20px;">
              <li><strong>ID</strong> - Unique identifier (e.g., "start", "chapter1", "ending_good")</li>
              <li><strong>Type</strong> - Controls what the event does:
                <ul style="margin-left: 20px; margin-top: 10px;">
                  <li><code>dialogue</code> - Display text with a speaking character</li>
                  <li><code>narration</code> - Display text without a character (narrator voice)</li>
                  <li><code>choice</code> - Present player with multiple options</li>
                </ul>
              </li>
              <li><strong>Text</strong> - The dialogue or narration content</li>
              <li><strong>Character</strong> - Which character is speaking (for dialogue events)</li>
              <li><strong>Background</strong> - The scene background image</li>
              <li><strong>Next Event</strong> - Which event plays after this one</li>
            </ul>

            <h3 style="color: #ffd700; margin-top: 30px;">üë§ Characters</h3>
            <p>Characters represent people in your story. Each character needs:</p>
            <ul style="margin-left: 20px;">
              <li><strong>ID</strong> - Unique identifier (e.g., "alex", "narrator")</li>
              <li><strong>Name</strong> - Display name shown in dialogue boxes</li>
              <li><strong>Color</strong> - Hex color for their name/text (e.g., #ff6b6b)</li>
              <li><strong>Sprites</strong> - Character images for different emotions:
                <ul style="margin-left: 20px; margin-top: 10px;">
                  <li><code>default</code> - Normal expression (required)</li>
                  <li><code>happy</code>, <code>sad</code>, <code>angry</code> - Optional emotions</li>
                  <li>Use format: <code>characterId.emotion</code> in events (e.g., "alex.happy")</li>
                </ul>
              </li>
            </ul>

            <h3 style="color: #ffd700; margin-top: 30px;">üîÄ Branching & Choices</h3>
            <p>Create interactive stories with choice events:</p>
            <ul style="margin-left: 20px;">
              <li>Set event type to <code>choice</code></li>
              <li>Add 2+ choices with text and next event ID</li>
              <li>Each choice can lead to different story paths</li>
              <li>Track player decisions in variables for later use</li>
            </ul>

            <h3 style="color: #ffd700; margin-top: 30px;">üñºÔ∏è Assets</h3>
            <p>Upload images to use in your game:</p>
            <ul style="margin-left: 20px;">
              <li><strong>Backgrounds</strong> - Scene images (e.g., "classroom.jpg")</li>
              <li><strong>Sprites</strong> - Character images (e.g., "alex_happy.png")</li>
              <li>Supported: PNG, JPG, GIF, WebP</li>
              <li>Assets are stored in IndexedDB (unlimited storage)</li>
              <li>Reference assets by filename in events</li>
            </ul>

            <h3 style="color: #ffd700; margin-top: 30px;">üíæ Variables & Conditions</h3>
            <p>Store game state and create conditional logic:</p>
            <ul style="margin-left: 20px;">
              <li>Use <code>setVariable</code> action to save values</li>
              <li>Check variables with conditions: <code>variable:score > 10</code></li>
              <li>Common patterns:
                <ul style="margin-left: 20px; margin-top: 10px;">
                  <li>Relationship points: <code>variable:alex_love += 1</code></li>
                  <li>Story flags: <code>variable:found_key = true</code></li>
                  <li>Branching: Check conditions to show different events</li>
                </ul>
              </li>
            </ul>

            <h3 style="color: #ffd700; margin-top: 30px;">üì¶ Export & Deploy</h3>
            <p>When your game is ready:</p>
            <ol style="margin-left: 20px;">
              <li>Click <strong>Export/Build</strong> to download your game as a ZIP</li>
              <li>ZIP contains: game.json (data) + all uploaded assets</li>
              <li>Use <strong>Import & Deploy</strong> to test in the Novellium Library</li>
              <li>Share your ZIP file with players or host on your website</li>
            </ol>

            <h3 style="color: #ffd700; margin-top: 30px;">üöÄ Quick Start Workflow</h3>
            <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 8px; border-left: 4px solid #ffd700; margin-top: 15px;">
              <ol style="margin: 0; padding-left: 20px;">
                <li>Fill out <strong>Project Info</strong> (title, ID, author)</li>
                <li>Create characters in <strong>Characters</strong> section</li>
                <li>Upload backgrounds/sprites in <strong>Assets</strong></li>
                <li>Build your story in <strong>Story Events</strong>:
                  <ul style="margin-top: 10px;">
                    <li>Start with event ID "start" (or your initial event)</li>
                    <li>Add dialogue events with characters</li>
                    <li>Link events together with "next" property</li>
                    <li>Add choice events for branching paths</li>
                  </ul>
                </li>
                <li>Save your project regularly</li>
                <li>Export and deploy to test in Library</li>
              </ol>
            </div>

            <h3 style="color: #ffd700; margin-top: 30px;">üí° Tips & Best Practices</h3>
            <ul style="margin-left: 20px;">
              <li>Use descriptive event IDs: "chapter1_intro" instead of "event1"</li>
              <li>Keep choice text short (1-2 lines max)</li>
              <li>Test your game frequently during development</li>
              <li>Use consistent naming for character sprites</li>
              <li>Add a "narrator" character for narration events</li>
              <li>Plan your story flow on paper before building</li>
              <li>Use variables to track important player choices</li>
            </ul>
          </div>
        </div>

        <!-- Project Info Section -->
        <div class="builder-section" id="section-project">
          <div class="section-header">
            <h2>üìÅ Project Information</h2>
            <p>Set up your visual novel's basic information</p>
          </div>

          <div class="form-group">
            <label>Game Title</label>
            <input type="text" id="project-title" placeholder="My Amazing Visual Novel">
            <p class="form-hint">The name of your visual novel</p>
          </div>

          <div class="form-group">
            <label>Game ID</label>
            <input type="text" id="project-id" placeholder="my-game">
            <p class="form-hint">Lowercase, no spaces (used for folder name)</p>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="project-description" placeholder="A captivating story about..."></textarea>
            <p class="form-hint">Brief description shown in game selection</p>
          </div>

          <div class="form-group">
            <label>Author</label>
            <input type="text" id="project-author" placeholder="Your Name">
          </div>

          <div class="form-group">
            <label>Initial Event</label>
            <input type="text" id="project-initial-event" placeholder="start" value="start">
            <p class="form-hint">The first event ID when game starts</p>
          </div>
        </div>

        <!-- Characters Section -->
        <div class="builder-section" id="section-characters">
          <div class="section-header">
            <h2>üë§ Characters</h2>
            <p>Define characters that appear in your story</p>
          </div>

          <button class="btn btn-primary" id="btn-add-character">+ Add Character</button>

          <div id="characters-list" style="margin-top: 20px;">
            <!-- Character items will be added here -->
          </div>

          <!-- Character Edit Form (hidden by default) -->
          <div id="character-form" style="display: none; margin-top: 20px;">
            <div class="event-builder">
              <h3 style="color: #ffd700;">Edit Character</h3>
              <div class="form-group">
                <label>Character ID</label>
                <input type="text" id="char-id" placeholder="hero">
              </div>
              <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="char-name" placeholder="Hero">
              </div>
              <div class="form-group">
                <label>Color (hex)</label>
                <input type="color" id="char-color" value="#ffd700">
              </div>
              <div class="form-group">
                <label>Sprites (comma-separated filenames)</label>
                <input type="text" id="char-sprites" placeholder="hero_neutral.png, hero_happy.png, hero_sad.png">
                <p class="form-hint">Optional: character images for different expressions</p>
              </div>
              <button class="btn btn-primary" id="btn-save-character">Save Character</button>
              <button class="btn btn-secondary" id="btn-cancel-character">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Events Section -->
        <div class="builder-section" id="section-events">
          <div class="section-header">
            <h2>üìñ Story Events</h2>
            <p>Create the narrative flow of your visual novel</p>
          </div>

          <button class="btn btn-primary" id="btn-add-event">+ Add Event</button>

          <div id="events-list" style="margin-top: 20px;">
            <!-- Event items will be added here -->
          </div>

          <!-- Event Edit Form (hidden by default) -->
          <div id="event-form" style="display: none; margin-top: 20px;">
            <div class="event-builder">
              <h3 style="color: #ffd700;">Edit Event</h3>
              
              <div class="form-group">
                <label>Event ID</label>
                <input type="text" id="event-id" placeholder="start">
                <p class="form-hint">Unique identifier for this event</p>
              </div>

              <div class="form-group">
                <label>Event Type</label>
                <div class="event-type-selector">
                  <div class="event-type-btn" data-type="dialogue">üí¨ Dialogue</div>
                  <div class="event-type-btn" data-type="choice">üîÄ Choice</div>
                  <div class="event-type-btn" data-type="scene">üé¨ Scene</div>
                  <div class="event-type-btn" data-type="narration">üìù Narration</div>
                </div>
              </div>

              <!-- Common Fields -->
              <div class="form-group">
                <label>Background Image</label>
                <input type="text" id="event-background" placeholder="backgrounds/forest_path.jpg">
                <p class="form-hint">Path relative to game folder</p>
              </div>

              <!-- Dialogue-specific fields -->
              <div id="dialogue-fields" style="display: none;">
                <div class="form-group">
                  <label>Character ID</label>
                  <select id="event-character"></select>
                </div>
                <div class="form-group">
                  <label>Dialogue Text</label>
                  <textarea id="event-text" placeholder="What the character says..."></textarea>
                </div>
                <div class="form-group">
                  <label>Character Sprite</label>
                  <input type="text" id="event-sprite" placeholder="characters/hero_neutral.png">
                </div>
                <div class="form-group">
                  <label>Next Event</label>
                  <input type="text" id="event-next" placeholder="next_event_id">
                </div>
              </div>

              <!-- Choice-specific fields -->
              <div id="choice-fields" style="display: none;">
                <div class="form-group">
                  <label>Choice Text</label>
                  <textarea id="event-choice-text" placeholder="What choice is being presented?"></textarea>
                </div>
                <div class="form-group">
                  <label>Options (one per line, format: text|next_event_id)</label>
                  <textarea id="event-options" placeholder="Go left|path_left&#10;Go right|path_right"></textarea>
                  <p class="form-hint">Format: Choice Text|next_event_id</p>
                </div>
              </div>

              <!-- Narration-specific fields -->
              <div id="narration-fields" style="display: none;">
                <div class="form-group">
                  <label>Narration Text</label>
                  <textarea id="event-narration" placeholder="Narrative text..."></textarea>
                </div>
                <div class="form-group">
                  <label>Next Event</label>
                  <input type="text" id="event-narration-next" placeholder="next_event_id">
                </div>
              </div>

              <button class="btn btn-primary" id="btn-save-event">Save Event</button>
              <button class="btn btn-secondary" id="btn-cancel-event">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Assets Section -->
        <div class="builder-section" id="section-assets">
          <div class="section-header">
            <h2>üñºÔ∏è Assets Management</h2>
            <p>Upload and manage your game's visual and audio assets</p>
          </div>

          <div class="event-builder">
            <h3 style="color: #ffd700;">Upload Assets</h3>
            
            <div class="form-group">
              <label>Asset Type</label>
              <select id="asset-type">
                <option value="backgrounds">Background Images</option>
                <option value="characters">Character Sprites</option>
                <option value="music">Background Music</option>
                <option value="sounds">Sound Effects</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label>Select Files</label>
              <input type="file" id="asset-upload" multiple accept="image/*,audio/*">
              <p class="form-hint">You can select multiple files at once</p>
            </div>

            <button class="btn btn-primary" id="btn-upload-assets">üì§ Upload & Store Files</button>
            <button class="btn btn-secondary" id="btn-download-all-assets">üì• Download All Assets</button>

            <h4 style="color: #ffd700; margin-top: 30px;">Uploaded Assets</h4>
            <div id="assets-list" style="max-height: 400px; overflow-y: auto;">
              <p style="color: #999;">No assets uploaded yet</p>
            </div>

            <hr style="border-color: rgba(255, 255, 255, 0.2); margin: 30px 0;">

            <h3 style="color: #ffd700;">Asset Guidelines</h3>
            <p>Recommended sizes and formats:</p>
            <ul style="color: #ccc;">
              <li><strong>Backgrounds:</strong> 1920x1080px (16:9 ratio) - .jpg or .png</li>
              <li><strong>Character Sprites:</strong> 512x1024px (transparent PNG)</li>
              <li><strong>Thumbnails:</strong> 400x225px (for game selection)</li>
              <li><strong>Music:</strong> .mp3 or .ogg format</li>
              <li><strong>Sound Effects:</strong> .mp3 or .ogg format</li>
            </ul>

            <p style="color: #ccc; margin-top: 20px;">
              <strong>Note:</strong> Files are stored in browser storage. Use "Download All Assets" to export them as a zip file for deployment.
            </p>
          </div>
        </div>

        <!-- Export Section -->
        <div class="builder-section" id="section-export">
          <div class="section-header">
            <h2>üì¶ Export & Build</h2>
            <p>Generate your game files</p>
          </div>

          <div class="event-builder">
            <h3 style="color: #ffd700;">Export Options</h3>
            
            <button class="btn btn-primary" id="btn-export-config" style="display: block; width: 100%; margin-bottom: 10px;">
              üìÑ Export config.json
            </button>
            <p class="form-hint">Download the game configuration file</p>

            <button class="btn btn-primary" id="btn-export-characters" style="display: block; width: 100%; margin-bottom: 10px;">
              üë§ Export characters.json
            </button>
            <p class="form-hint">Download the characters definition file</p>

            <button class="btn btn-primary" id="btn-export-events" style="display: block; width: 100%; margin-bottom: 10px;">
              üìñ Export events.json
            </button>
            <p class="form-hint">Download the story events file</p>

            <button class="btn btn-primary" id="btn-export-all" style="display: block; width: 100%; margin-bottom: 10px;">
              üì¶ Export Complete Package (ZIP)
            </button>
            <p class="form-hint">Download all JSON files and assets as a zip file</p>

            <hr style="border-color: rgba(255, 255, 255, 0.2); margin: 30px 0;">

            <h3 style="color: #ffd700;">Manual Installation Instructions</h3>
            <ol style="color: #ccc; line-height: 1.8;">
              <li>Export Complete Package (ZIP) using button above</li>
              <li>Go to "üì• Import & Deploy" tab to upload and deploy</li>
              <li>Or manually extract and place in <code>gamefolder/[your-game-id]/</code></li>
              <li>Update <code>games-list.json</code> to include your game</li>
              <li>Test in Novellium!</li>
            </ol>
          </div>
        </div>

        <!-- Import & Deploy Section -->
        <div class="builder-section" id="section-import">
          <div class="section-header">
            <h2>üì• Import & Deploy to Library</h2>
            <p>Upload a game package and choose where to deploy it</p>
          </div>

          <div class="event-builder">
            <h3 style="color: #ffd700;">Upload Game Package</h3>
            <p style="color: #ccc;">Upload a ZIP file containing your game files (config.json, characters.json, events.json, and assets)</p>
            
            <div class="form-group">
              <label>Select ZIP File</label>
              <input type="file" id="import-zip-file" accept=".zip">
              <p class="form-hint">Choose a game package created with "Export Complete Package"</p>
            </div>

            <div class="form-group">
              <label>Import Mode</label>
              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-secondary import-mode-btn" id="btn-mode-local" data-mode="local" style="flex: 1;">
                  üíª Local Import
                  <br><small style="opacity: 0.8;">Save to local library only</small>
                </button>
                <button class="btn btn-secondary import-mode-btn" id="btn-mode-cloud" data-mode="cloud" style="flex: 1;">
                  üåä Cloud Import
                  <br><small style="opacity: 0.8;">Upload to public cloud library</small>
                </button>
              </div>
              <p class="form-hint" id="mode-description">Choose how to import your game</p>
            </div>

            <button class="btn btn-primary" id="btn-import-and-deploy" style="display: block; width: 100%; background: linear-gradient(135deg, #00d4ff, #0099ff);" disabled>
              üöÄ Import Game
            </button>

            <div id="import-status" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;">
              <!-- Status messages will appear here -->
            </div>
          </div>

          <hr style="border-color: rgba(255, 255, 255, 0.2); margin: 30px 0;">

          <div class="event-builder">
            <h3 style="color: #ffd700;">Deploy Current Project</h3>
            <p style="color: #ccc;">Deploy the game you're currently working on (from Project Info, Characters, Events, Assets tabs)</p>
            
            <div class="form-group">
              <label>Deploy Mode</label>
              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-secondary deploy-mode-btn" id="btn-deploy-local" data-mode="local" style="flex: 1;">
                  üíª Local Deploy
                  <br><small style="opacity: 0.8;">Save to local library</small>
                </button>
                <button class="btn btn-secondary deploy-mode-btn" id="btn-deploy-cloud" data-mode="cloud" style="flex: 1;">
                  üåä Cloud Deploy
                  <br><small style="opacity: 0.8;">Upload to public cloud</small>
                </button>
              </div>
            </div>

            <button class="btn btn-primary" id="btn-deploy-current" style="display: block; width: 100%; background: linear-gradient(135deg, #ffd700, #ffed4e); color: #1a1a2e;" disabled>
              üöÄ Deploy Current Project
            </button>

            <div id="deploy-status" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;">
              <!-- Status messages will appear here -->
            </div>
          </div>
        </div>
        </div><!-- End form-mode-container -->
      </div>
    </div>
  </div>

  <script type="module">
    // Import Supabase for cloud functionality
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
    
    // Initialize Supabase client
    const supabaseUrl = 'https://ynxrocumivaenpoyxskf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlueHJvY3VtaXZhZW5wb3l4c2tmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDM3ODQsImV4cCI6MjA3Njk3OTc4NH0.kK8yinWZyfmhsY5P7hyh3UKl1WKUAo6IW4bvS-4hO4o';
    const supabase = createClient(supabaseUrl, supabaseKey);
    
    // Global variables for mode selection
    let selectedImportMode = null;
    let selectedDeployMode = null;

    // Wait for JSZip to load
    function waitForJSZip() {
      return new Promise((resolve) => {
        if (typeof JSZip !== 'undefined') {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (typeof JSZip !== 'undefined') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    }

    // Project data structure
    let projectData = {
      info: {
        title: '',
        id: '',
        description: '',
        author: '',
        initialEvent: 'start'
      },
      characters: [],
      events: []
    };

    let editingCharacterIndex = -1;
    let editingEventIndex = -1;
    let currentJsonTab = 'project';
    let isJsonMode = false;
    let currentSection = 'howto';

    // Mode selection functionality
    function initializeModeSelection() {
      // Import mode buttons
      document.querySelectorAll('.import-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.import-mode-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedImportMode = btn.dataset.mode;
          
          const importBtn = document.getElementById('btn-import-and-deploy');
          const description = document.getElementById('mode-description');
          
          if (selectedImportMode === 'local') {
            importBtn.textContent = 'üíª Import to Local Library';
            description.textContent = 'Game will be saved locally and available only on this device';
          } else if (selectedImportMode === 'cloud') {
            importBtn.textContent = 'üåä Import to Cloud Library';
            description.textContent = 'Game will be uploaded to the public cloud and available to everyone';
          }
          
          importBtn.disabled = false;
        });
      });

      // Deploy mode buttons
      document.querySelectorAll('.deploy-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.deploy-mode-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedDeployMode = btn.dataset.mode;
          
          const deployBtn = document.getElementById('btn-deploy-current');
          
          if (selectedDeployMode === 'local') {
            deployBtn.textContent = 'üíª Deploy to Local Library';
          } else if (selectedDeployMode === 'cloud') {
            deployBtn.textContent = 'üåä Deploy to Cloud Library';
          }
          
          deployBtn.disabled = false;
        });
      });
    }

    // Initialize mode selection when page loads
    waitForJSZip().then(() => {
      initializeModeSelection();
    });

    // Save project info
    function saveProjectInfo() {
      projectData.info = {
        title: document.getElementById('project-title').value,
        id: document.getElementById('project-id').value,
        description: document.getElementById('project-description').value,
        author: document.getElementById('project-author').value,
        initialEvent: document.getElementById('project-initial-event').value
      };
      localStorage.setItem('vn_builder_project', JSON.stringify(projectData));
    }

    // Load project from localStorage
    function loadProject() {
      const saved = localStorage.getItem('vn_builder_project');
      if (saved) {
        projectData = JSON.parse(saved);
        
        // Load project info
        document.getElementById('project-title').value = projectData.info.title || '';
        document.getElementById('project-id').value = projectData.info.id || '';
        document.getElementById('project-description').value = projectData.info.description || '';
        document.getElementById('project-author').value = projectData.info.author || '';
        document.getElementById('project-initial-event').value = projectData.info.initialEvent || 'start';

        // Refresh lists
        refreshCharactersList();
        refreshEventsList();
      }
    }

    // Setup navigation and ALL event listeners
    function setupEventListeners() {
      console.log('Setting up event listeners...');
      
      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          console.log('Nav clicked:', item.dataset.section);
          // Update nav
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          // Show section
          const section = item.dataset.section;
          currentSection = section;
          
          // Show/hide mode toggle based on section
          const modeToggle = document.querySelector('.mode-toggle');
          if (section === 'project' || section === 'characters' || section === 'events') {
            modeToggle.style.display = 'flex';
            // Update JSON tab to match section
            if (isJsonMode) {
              currentJsonTab = section;
              loadJsonEditor();
            }
          } else {
            modeToggle.style.display = 'none';
            // Force back to form mode for other sections
            if (isJsonMode) {
              isJsonMode = false;
              toggleMode();
            }
          }
          
          if (!isJsonMode) {
            document.querySelectorAll('.builder-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${section}`).classList.add('active');
          }
        });
      });

      // Project Info - Auto-generate ID from title
      document.getElementById('project-title')?.addEventListener('input', (e) => {
        const title = e.target.value;
        const id = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        document.getElementById('project-id').value = id;
      });

      // Auto-save on field change
      ['project-title', 'project-id', 'project-description', 'project-author', 'project-initial-event'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', saveProjectInfo);
      });

      // Save project button
      document.getElementById('btn-save-project')?.addEventListener('click', () => {
        saveProjectInfo();
        alert('Project saved to browser storage!');
      });

      // Mode toggle
      document.getElementById('mode-switch')?.addEventListener('click', () => {
        isJsonMode = !isJsonMode;
        currentJsonTab = currentSection; // Match JSON tab to current section
        toggleMode();
      });

      // JSON tabs - removed since we auto-sync with navigation now

      // JSON editor buttons
      document.getElementById('btn-apply-json')?.addEventListener('click', () => {
        applyJsonChanges();
      });

      document.getElementById('btn-format-json')?.addEventListener('click', () => {
        formatJson();
      });

      document.getElementById('btn-validate-json')?.addEventListener('click', () => {
        validateJson();
      });
    }

    // Toggle between Form and JSON mode
    function toggleMode() {
      const modeSwitch = document.getElementById('mode-switch');
      const formContainer = document.getElementById('form-mode-container');
      const jsonContainer = document.getElementById('json-editor-container');
      
      if (isJsonMode) {
        modeSwitch.classList.add('active');
        formContainer.style.display = 'none';
        jsonContainer.classList.add('active');
        loadJsonEditor();
      } else {
        modeSwitch.classList.remove('active');
        formContainer.style.display = 'block';
        jsonContainer.classList.remove('active');
      }
    }

    // Load current data into JSON editor
    function loadJsonEditor() {
      const editor = document.getElementById('json-editor');
      const title = document.getElementById('json-editor-title');
      const desc = document.getElementById('json-editor-desc');
      let jsonData = {};

      if (currentJsonTab === 'project') {
        title.textContent = 'üìÅ Project Info JSON';
        desc.textContent = 'Edit project configuration (config.json)';
        jsonData = {
          title: projectData.info.title,
          author: projectData.info.author,
          description: projectData.info.description,
          initialEvent: projectData.info.initialEvent
        };
      } else if (currentJsonTab === 'characters') {
        title.textContent = 'üë§ Characters JSON';
        desc.textContent = 'Edit character definitions (characters.json)';
        const characters = {};
        projectData.characters.forEach(char => {
          characters[char.id] = {
            name: char.name,
            color: char.color,
            sprites: char.sprites.length > 0 ? char.sprites : undefined
          };
        });
        jsonData = { characters };
      } else if (currentJsonTab === 'events') {
        title.textContent = 'üìñ Story Events JSON';
        desc.textContent = 'Edit story events (events.json)';
        const events = {};
        projectData.events.forEach(event => {
          events[event.id] = { ...event };
          delete events[event.id].id;
        });
        jsonData = { events };
      }

      editor.value = JSON.stringify(jsonData, null, 2);
    }

    // Apply JSON changes to project data
    function applyJsonChanges() {
      const editor = document.getElementById('json-editor');
      
      try {
        const jsonData = JSON.parse(editor.value);

        if (currentJsonTab === 'project') {
          projectData.info.title = jsonData.title || '';
          projectData.info.author = jsonData.author || '';
          projectData.info.description = jsonData.description || '';
          projectData.info.initialEvent = jsonData.initialEvent || 'start';
          
          // Auto-generate ID if title changed
          if (jsonData.title) {
            projectData.info.id = jsonData.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
          }
        } else if (currentJsonTab === 'characters') {
          projectData.characters = [];
          if (jsonData.characters) {
            Object.entries(jsonData.characters).forEach(([id, data]) => {
              projectData.characters.push({
                id: id,
                name: data.name,
                color: data.color,
                sprites: data.sprites || []
              });
            });
          }
        } else if (currentJsonTab === 'events') {
          projectData.events = [];
          if (jsonData.events) {
            Object.entries(jsonData.events).forEach(([id, data]) => {
              projectData.events.push({
                id: id,
                ...data
              });
            });
          }
        }

        saveProjectInfo();
        alert('‚úÖ JSON changes applied successfully!');
        
        // Refresh form views
        if (projectData.info.title) {
          document.getElementById('project-title').value = projectData.info.title;
          document.getElementById('project-id').value = projectData.info.id || '';
          document.getElementById('project-description').value = projectData.info.description || '';
          document.getElementById('project-author').value = projectData.info.author || '';
          document.getElementById('project-initial-event').value = projectData.info.initialEvent || 'start';
        }
        refreshCharactersList();
        refreshEventsList();

      } catch (error) {
        alert('‚ùå JSON Error: ' + error.message);
      }
    }

    // Format JSON with proper indentation
    function formatJson() {
      const editor = document.getElementById('json-editor');
      
      try {
        const jsonData = JSON.parse(editor.value);
        editor.value = JSON.stringify(jsonData, null, 2);
        alert('‚úÖ JSON formatted successfully!');
      } catch (error) {
        alert('‚ùå Cannot format invalid JSON: ' + error.message);
      }
    }

    // Validate JSON syntax
    function validateJson() {
      const editor = document.getElementById('json-editor');
      
      try {
        JSON.parse(editor.value);
        alert('‚úÖ JSON is valid!');
      } catch (error) {
        alert('‚ùå JSON Error: ' + error.message);
      }
    }

    // Characters Management
    document.getElementById('btn-add-character').addEventListener('click', () => {
      editingCharacterIndex = -1;
      document.getElementById('char-id').value = '';
      document.getElementById('char-name').value = '';
      document.getElementById('char-color').value = '#ffd700';
      document.getElementById('char-sprites').value = '';
      document.getElementById('character-form').style.display = 'block';
    });

    document.getElementById('btn-save-character').addEventListener('click', () => {
      const character = {
        id: document.getElementById('char-id').value,
        name: document.getElementById('char-name').value,
        color: document.getElementById('char-color').value,
        sprites: document.getElementById('char-sprites').value.split(',').map(s => s.trim()).filter(s => s)
      };

      if (!character.id || !character.name) {
        alert('Please fill in ID and Name');
        return;
      }

      if (editingCharacterIndex === -1) {
        projectData.characters.push(character);
      } else {
        projectData.characters[editingCharacterIndex] = character;
      }

      saveProjectInfo();
      refreshCharactersList();
      document.getElementById('character-form').style.display = 'none';
    });

    document.getElementById('btn-cancel-character').addEventListener('click', () => {
      document.getElementById('character-form').style.display = 'none';
    });

    function refreshCharactersList() {
      const list = document.getElementById('characters-list');
      list.innerHTML = '';

      if (projectData.characters.length === 0) {
        list.innerHTML = '<p style="color: #999;">No characters yet. Click "Add Character" to create one.</p>';
        return;
      }

      projectData.characters.forEach((char, index) => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
          <div class="list-item-info">
            <h4>${char.name} (${char.id})</h4>
            <p>Color: ${char.color} | Sprites: ${char.sprites.length || 0}</p>
          </div>
          <div class="list-item-actions">
            <button class="btn btn-secondary btn-edit-character" data-index="${index}">Edit</button>
            <button class="btn btn-danger btn-delete-character" data-index="${index}">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });

      // Attach event listeners
      document.querySelectorAll('.btn-edit-character').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          editingCharacterIndex = index;
          const char = projectData.characters[index];
          document.getElementById('char-id').value = char.id;
          document.getElementById('char-name').value = char.name;
          document.getElementById('char-color').value = char.color;
          document.getElementById('char-sprites').value = char.sprites.join(', ');
          document.getElementById('character-form').style.display = 'block';
        });
      });

      document.querySelectorAll('.btn-delete-character').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Delete this character?')) {
            const index = parseInt(btn.dataset.index);
            projectData.characters.splice(index, 1);
            saveProjectInfo();
            refreshCharactersList();
          }
        });
      });

      // Update character dropdown in events
      updateCharacterDropdown();
    }

    function updateCharacterDropdown() {
      const select = document.getElementById('event-character');
      select.innerHTML = '<option value="">Narrator</option>';
      projectData.characters.forEach(char => {
        select.innerHTML += `<option value="${char.id}">${char.name}</option>`;
      });
    }

    // Events Management
    document.getElementById('btn-add-event').addEventListener('click', () => {
      editingEventIndex = -1;
      document.getElementById('event-id').value = '';
      document.getElementById('event-background').value = '';
      document.querySelectorAll('.event-type-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('event-form').style.display = 'block';
      hideAllEventFields();
    });

    document.querySelectorAll('.event-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.event-type-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        const type = btn.dataset.type;
        hideAllEventFields();
        
        if (type === 'dialogue') {
          document.getElementById('dialogue-fields').style.display = 'block';
        } else if (type === 'choice') {
          document.getElementById('choice-fields').style.display = 'block';
        } else if (type === 'narration') {
          document.getElementById('narration-fields').style.display = 'block';
        }
      });
    });

    function hideAllEventFields() {
      document.getElementById('dialogue-fields').style.display = 'none';
      document.getElementById('choice-fields').style.display = 'none';
      document.getElementById('narration-fields').style.display = 'none';
    }

    document.getElementById('btn-save-event').addEventListener('click', () => {
      const selectedType = document.querySelector('.event-type-btn.selected');
      if (!selectedType) {
        alert('Please select an event type');
        return;
      }

      const type = selectedType.dataset.type;
      const eventId = document.getElementById('event-id').value;
      const background = document.getElementById('event-background').value;

      if (!eventId) {
        alert('Please provide an Event ID');
        return;
      }

      let event = {
        id: eventId,
        type: type,
        background: background
      };

      if (type === 'dialogue') {
        event.character = document.getElementById('event-character').value;
        event.text = document.getElementById('event-text').value;
        event.sprite = document.getElementById('event-sprite').value;
        event.next = document.getElementById('event-next').value;
      } else if (type === 'choice') {
        event.text = document.getElementById('event-choice-text').value;
        const optionsText = document.getElementById('event-options').value;
        event.options = optionsText.split('\n').map(line => {
          const [text, next] = line.split('|').map(s => s.trim());
          return { text, next };
        }).filter(opt => opt.text && opt.next);
      } else if (type === 'narration') {
        event.text = document.getElementById('event-narration').value;
        event.next = document.getElementById('event-narration-next').value;
      }

      if (editingEventIndex === -1) {
        projectData.events.push(event);
      } else {
        projectData.events[editingEventIndex] = event;
      }

      saveProjectInfo();
      refreshEventsList();
      document.getElementById('event-form').style.display = 'none';
    });

    document.getElementById('btn-cancel-event').addEventListener('click', () => {
      document.getElementById('event-form').style.display = 'none';
    });

    function refreshEventsList() {
      const list = document.getElementById('events-list');
      list.innerHTML = '';

      if (projectData.events.length === 0) {
        list.innerHTML = '<p style="color: #999;">No events yet. Click "Add Event" to create one.</p>';
        return;
      }

      projectData.events.forEach((event, index) => {
        const item = document.createElement('div');
        item.className = 'list-item';
        const preview = event.text ? event.text.substring(0, 50) + '...' : 'No text';
        item.innerHTML = `
          <div class="list-item-info">
            <h4>${event.id} (${event.type})</h4>
            <p>${preview}</p>
          </div>
          <div class="list-item-actions">
            <button class="btn btn-secondary btn-edit-event" data-index="${index}">Edit</button>
            <button class="btn btn-danger btn-delete-event" data-index="${index}">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });

      // Attach event listeners
      document.querySelectorAll('.btn-edit-event').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          editingEventIndex = index;
          const event = projectData.events[index];
          
          document.getElementById('event-id').value = event.id;
          document.getElementById('event-background').value = event.background || '';
          
          // Select type
          document.querySelectorAll('.event-type-btn').forEach(b => {
            if (b.dataset.type === event.type) {
              b.classList.add('selected');
            } else {
              b.classList.remove('selected');
            }
          });
          
          hideAllEventFields();
          
          if (event.type === 'dialogue') {
            document.getElementById('dialogue-fields').style.display = 'block';
            document.getElementById('event-character').value = event.character || '';
            document.getElementById('event-text').value = event.text || '';
            document.getElementById('event-sprite').value = event.sprite || '';
            document.getElementById('event-next').value = event.next || '';
          } else if (event.type === 'choice') {
            document.getElementById('choice-fields').style.display = 'block';
            document.getElementById('event-choice-text').value = event.text || '';
            const optionsText = event.options.map(opt => `${opt.text}|${opt.next}`).join('\n');
            document.getElementById('event-options').value = optionsText;
          } else if (event.type === 'narration') {
            document.getElementById('narration-fields').style.display = 'block';
            document.getElementById('event-narration').value = event.text || '';
            document.getElementById('event-narration-next').value = event.next || '';
          }
          
          document.getElementById('event-form').style.display = 'block';
        });
      });

      document.querySelectorAll('.btn-delete-event').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Delete this event?')) {
            const index = parseInt(btn.dataset.index);
            projectData.events.splice(index, 1);
            saveProjectInfo();
            refreshEventsList();
          }
        });
      });
    }

    // Export Functions
    document.getElementById('btn-export-config').addEventListener('click', () => {
      saveProjectInfo();
      const config = {
        title: projectData.info.title,
        author: projectData.info.author,
        initialEvent: projectData.info.initialEvent
      };
      downloadJSON('config.json', config);
    });

    document.getElementById('btn-export-characters').addEventListener('click', () => {
      saveProjectInfo();
      const characters = {};
      projectData.characters.forEach(char => {
        characters[char.id] = {
          name: char.name,
          color: char.color,
          sprites: char.sprites.length > 0 ? char.sprites : undefined
        };
      });
      downloadJSON('characters.json', { characters });
    });

    document.getElementById('btn-export-events').addEventListener('click', () => {
      saveProjectInfo();
      const events = {};
      projectData.events.forEach(event => {
        events[event.id] = { ...event };
        delete events[event.id].id;
      });
      downloadJSON('events.json', { events });
    });

    // Export complete package as ZIP
    document.getElementById('btn-export-all').addEventListener('click', async () => {
      saveProjectInfo();
      
      if (!projectData.info.id) {
        alert('Please set a Game ID in Project Info first');
        return;
      }

      const zip = new JSZip();
      
      // Add config.json
      const config = {
        title: projectData.info.title,
        author: projectData.info.author,
        initialEvent: projectData.info.initialEvent
      };
      zip.file('config.json', JSON.stringify(config, null, 2));

      // Add characters.json
      const characters = {};
      projectData.characters.forEach(char => {
        characters[char.id] = {
          name: char.name,
          color: char.color,
          sprites: char.sprites.length > 0 ? char.sprites : undefined
        };
      });
      zip.file('characters.json', JSON.stringify({ characters }, null, 2));

      // Add events.json
      const events = {};
      projectData.events.forEach(event => {
        events[event.id] = { ...event };
        delete events[event.id].id;
      });
      zip.file('events.json', JSON.stringify({ events }, null, 2));

      // Add assets
      const assets = await getAllAssets();
      const gameAssets = assets.filter(a => a.gameId === projectData.info.id);
      
      for (const asset of gameAssets) {
        // Convert base64 to blob
        const base64Data = asset.data.split(',')[1];
        const binaryData = atob(base64Data);
        const bytes = new Uint8Array(binaryData.length);
        for (let i = 0; i < binaryData.length; i++) {
          bytes[i] = binaryData.charCodeAt(i);
        }
        
        // Add to appropriate folder
        zip.file(`${asset.type}/${asset.filename}`, bytes);
      }

      // Generate and download zip
      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${projectData.info.id}-complete.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('Complete game package downloaded as ZIP!');
    });

    // Deploy game to engine with mode selection
    document.getElementById('btn-deploy-current').addEventListener('click', async () => {
      if (!selectedDeployMode) {
        alert('Please select a deploy mode first (Local or Cloud)');
        return;
      }
      
      if (selectedDeployMode === 'local') {
        await deployGameToEngine(projectData, 'deploy-status');
      } else if (selectedDeployMode === 'cloud') {
        await deployCurrentToCloud();
      }
    });

    // Import and deploy ZIP file with mode selection
    document.getElementById('btn-import-and-deploy').addEventListener('click', async () => {
      if (!selectedImportMode) {
        alert('Please select an import mode first (Local or Cloud)');
        return;
      }

      const fileInput = document.getElementById('import-zip-file');
      const statusDiv = document.getElementById('import-status');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(255, 107, 107, 0.2)';
        statusDiv.style.borderLeft = '4px solid #ff6b6b';
        statusDiv.innerHTML = '<p style="color: #ff6b6b; margin: 0;">‚ùå Please select a ZIP file first</p>';
        return;
      }

      const zipFile = fileInput.files[0];
      
      statusDiv.style.display = 'block';
      statusDiv.style.background = 'rgba(255, 165, 0, 0.2)';
      statusDiv.style.borderLeft = '4px solid #ffa500';
      statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Reading ZIP file...</p>';

      try {
        // Read ZIP file
        const zip = new JSZip();
        const contents = await zip.loadAsync(zipFile);
        
        statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Extracting files...</p>';

        // Debug: List all files in the ZIP
        console.log('Files in ZIP:');
        Object.keys(contents.files).forEach(filename => {
          console.log('- ' + filename);
        });

        // Find the game folder (look for the first folder that contains config.json)
        let gameFolder = '';
        const configPaths = Object.keys(contents.files).filter(path => path.endsWith('config.json'));
        
        if (configPaths.length === 0) {
          throw new Error('No config.json found in ZIP file');
        }
        
        // Use the first config.json found
        const configPath = configPaths[0];
        gameFolder = configPath.replace('config.json', '');
        
        console.log('Game folder detected:', gameFolder);
        console.log('Config path:', configPath);

        // Extract JSON files
        let config, characters, events;
        
        try {
          const configFile = contents.file(configPath);
          if (!configFile) throw new Error(`config.json not found at ${configPath}`);
          config = JSON.parse(await configFile.async('string'));
          
          // Debug: Log the config structure
          console.log('Loaded config:', config);
          
          // Validate that we have at least a title/name
          if (!config.title && !config.name) {
            throw new Error('Config file missing title/name field');
          }
        } catch (e) {
          throw new Error('Failed to load config.json: ' + e.message);
        }

        try {
          const charactersPath = gameFolder + 'characters.json';
          const charactersFile = contents.file(charactersPath);
          if (!charactersFile) throw new Error(`characters.json not found at ${charactersPath}`);
          const charactersData = JSON.parse(await charactersFile.async('string'));
          characters = charactersData.characters || {};
        } catch (e) {
          throw new Error('Failed to load characters.json: ' + e.message);
        }

        try {
          const eventsPath = gameFolder + 'story.json';
          let eventsFile = contents.file(eventsPath);
          
          // Try events.json if story.json doesn't exist
          if (!eventsFile) {
            const altEventsPath = gameFolder + 'events.json';
            eventsFile = contents.file(altEventsPath);
            if (!eventsFile) throw new Error(`Neither story.json nor events.json found in ${gameFolder}`);
          }
          
          const eventsData = JSON.parse(await eventsFile.async('string'));
          events = eventsData.events || {};
        } catch (e) {
          throw new Error('Failed to load events/story.json: ' + e.message);
        }

        statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Extracting assets...</p>';

        // Extract assets from the detected game folder
        const assets = {};
        const assetFolders = ['backgrounds', 'sprites', 'characters', 'music', 'sounds', 'other'];
        
        for (const folder of assetFolders) {
          const folderPath = gameFolder + folder + '/';
          console.log('Looking for assets in:', folderPath);
          
          // Find all files in this folder
          const folderFiles = Object.keys(contents.files).filter(path => 
            path.startsWith(folderPath) && !contents.files[path].dir
          );
          
          for (const filePath of folderFiles) {
            const filename = filePath.split('/').pop(); // Get just the filename
            const fileObj = contents.files[filePath];
            
            console.log('Processing asset:', filename, 'from', filePath);
            
            const fileData = await fileObj.async('base64');
            const mimeType = getMimeType(filename);
            assets[filename] = `data:${mimeType};base64,${fileData}`;
          }
        }

        // Generate game ID from title if not present
        const title = config.title || config.name || 'Untitled Game';
        const author = config.author || 'Unknown Author';
        const initialEvent = config.initialEvent || config.startEvent || 'start';
        const gameId = config.gameId || config.id || title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

        // Create project data structure
        const importedProject = {
          info: {
            title: title,
            id: gameId,
            description: config.description || '',
            author: author,
            initialEvent: initialEvent
          },
          characters: Object.entries(characters).map(([id, data]) => ({
            id: id,
            name: data.name,
            color: data.color,
            sprites: data.sprites || []
          })),
          events: Object.entries(events).map(([id, data]) => ({
            id: id,
            ...data
          }))
        };

        if (selectedImportMode === 'local') {
          // Local import - existing functionality
          statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Deploying to local library...</p>';
          window.importedAssets = assets;
          window.importedGameId = gameId;
          await deployGameToEngine(importedProject, 'import-status', assets, gameId);
        } else if (selectedImportMode === 'cloud') {
          // Cloud import - upload assets and game data to Supabase
          await importToCloud(importedProject, assets, statusDiv);
        }

        // Clear file input
        fileInput.value = '';

      } catch (error) {
        console.error('Import error:', error);
        statusDiv.style.background = 'rgba(255, 107, 107, 0.2)';
        statusDiv.style.borderLeft = '4px solid #ff6b6b';
        statusDiv.innerHTML = `
          <h4 style="color: #ff6b6b; margin: 0 0 10px 0;">‚ùå Import Failed</h4>
          <p style="color: #ff6b6b; margin: 0;">${error.message}</p>
        `;
      }
    });

    // Deploy current project to cloud
    async function deployCurrentToCloud() {
      const statusDiv = document.getElementById('deploy-status');
      statusDiv.style.display = 'block';
      statusDiv.style.background = 'rgba(255, 165, 0, 0.2)';
      statusDiv.style.borderLeft = '4px solid #ffa500';
      statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Preparing current project for cloud...</p>';
      
      try {
        // Validation
        if (!projectData.info.title || !projectData.info.author) {
          throw new Error('Please fill in at least the game title and author');
        }
        
        if (projectData.characters.length === 0) {
          throw new Error('Please add at least one character');
        }
        
        if (projectData.events.length === 0) {
          throw new Error('Please add at least one event');
        }
        
        const gameId = projectData.info.id || projectData.info.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        
        statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Converting project data...</p>';
        
        // Convert project structure to database format
        const charactersObj = {};
        projectData.characters.forEach(char => {
          charactersObj[char.id] = {
            name: char.name,
            color: char.color,
            sprites: char.sprites || []
          };
        });
        
        const eventsObj = {};
        projectData.events.forEach(event => {
          eventsObj[event.id] = { ...event };
          delete eventsObj[event.id].id;
        });
        
        statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Uploading to cloud database...</p>';
        
        // Upload game to Supabase database
        const gameData = {
          title: projectData.info.title,
          author: projectData.info.author,
          description: projectData.info.description || '',
          game_id: gameId,
          config: {
            title: projectData.info.title,
            author: projectData.info.author,
            initialEvent: projectData.info.initialEvent
          },
          characters: charactersObj,
          events: eventsObj,
          is_public: true
        };
        
        const { data, error } = await supabase
          .from('games')
          .insert([gameData])
          .select()
          .single();
        
        if (error) {
          if (error.code === '23505') {
            throw new Error(`Game with ID "${gameId}" already exists. Please choose a different title or modify the game ID.`);
          }
          throw new Error(`Database error: ${error.message}`);
        }
        
        statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
        statusDiv.style.borderLeft = '4px solid #22c55e';
        statusDiv.innerHTML = `
          <h4 style="color: #22c55e; margin: 0 0 10px 0;">‚úÖ Cloud Deploy Successful!</h4>
          <p style="color: #22c55e; margin: 0 0 5px 0;">Game "${projectData.info.title}" deployed to cloud</p>
          <p style="color: #ccc; margin: 0; font-size: 12px;">Game ID: ${gameId}</p>
          <p style="color: #ccc; margin: 5px 0 0 0; font-size: 12px;">Your game is now publicly available in the cloud library! üåä</p>
          <p style="color: #ffa500; margin: 10px 0 0 0; font-size: 12px;">Note: Assets (images/audio) need to be uploaded separately via import for full cloud compatibility</p>
        `;
        
      } catch (error) {
        console.error('Cloud deploy error:', error);
        statusDiv.style.background = 'rgba(255, 107, 107, 0.2)';
        statusDiv.style.borderLeft = '4px solid #ff6b6b';
        statusDiv.innerHTML = `
          <h4 style="color: #ff6b6b; margin: 0 0 10px 0;">‚ùå Cloud Deploy Failed</h4>
          <p style="color: #ff6b6b; margin: 0;">${error.message}</p>
        `;
      }
    }

    // Cloud import functionality
    async function importToCloud(project, assets, statusDiv) {
      statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Uploading assets to cloud storage...</p>';
      
      const gameId = project.info.id;
      const uploadedAssetUrls = {};
      
      try {
        // Upload each asset to Supabase Storage
        let uploadedCount = 0;
        const totalAssets = Object.keys(assets).length;
        
        for (const [filename, dataUrl] of Object.entries(assets)) {
          statusDiv.innerHTML = `<p style="color: #ffa500; margin: 0;">‚è≥ Uploading ${filename} (${uploadedCount + 1}/${totalAssets})...</p>`;
          
          // Convert data URL to file with proper MIME type
          const mimeType = getMimeType(filename);
          console.log(`Uploading ${filename} with MIME type: ${mimeType}`);
          
          // Convert data URL to blob with correct MIME type
          const response = await fetch(dataUrl);
          const arrayBuffer = await response.arrayBuffer();
          
          // Create blob with correct MIME type
          const blob = new Blob([arrayBuffer], { type: mimeType });
          
          // Create file with correct MIME type
          const file = new File([blob], filename, { type: mimeType });
          
          // Upload to Supabase Storage
          const filePath = `${gameId}/${filename}`;
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('game-assets')
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: true,
              contentType: mimeType
            });
          
          if (uploadError) throw new Error(`Failed to upload ${filename}: ${uploadError.message}`);
          
          // Get public URL
          const { data: urlData } = supabase.storage
            .from('game-assets')
            .getPublicUrl(filePath);
          
          uploadedAssetUrls[filename] = urlData.publicUrl;
          uploadedCount++;
        }
        
        statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Updating asset references...</p>';
        
        // Update asset paths in game data to use cloud URLs
        const updatedCharacters = { ...project.info.characters };
        const updatedEvents = { ...project.info.events };
        
        // Convert project structure to match database format
        const charactersObj = {};
        project.characters.forEach(char => {
          charactersObj[char.id] = {
            name: char.name,
            color: char.color,
            sprites: char.sprites || []
          };
        });
        
        const eventsObj = {};
        project.events.forEach(event => {
          eventsObj[event.id] = { ...event };
          delete eventsObj[event.id].id;
          
          // Update asset references in events
          if (eventsObj[event.id].background) {
            const filename = eventsObj[event.id].background.split('/').pop();
            if (uploadedAssetUrls[filename]) {
              eventsObj[event.id].background = uploadedAssetUrls[filename];
            }
          }
          
          if (eventsObj[event.id].sprite) {
            const filename = eventsObj[event.id].sprite.split('/').pop();
            if (uploadedAssetUrls[filename]) {
              eventsObj[event.id].sprite = uploadedAssetUrls[filename];
            }
          }
        });
        
        // Update sprite references in characters
        Object.values(charactersObj).forEach(char => {
          if (char.sprites && Array.isArray(char.sprites)) {
            char.sprites = char.sprites.map(sprite => {
              const filename = sprite.split('/').pop();
              const cloudUrl = uploadedAssetUrls[filename];
              console.log(`Updating sprite ${sprite} -> filename: ${filename} -> cloudUrl: ${cloudUrl || 'NOT FOUND'}`);
              return cloudUrl || sprite;
            });
          }
        });
        
        statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Generating thumbnail...</p>';
        
        // Generate thumbnail from first background image
        let thumbnailUrl = null;
        const firstEventWithBackground = project.events.find(event => event.background);
        if (firstEventWithBackground) {
          const backgroundFilename = firstEventWithBackground.background.split('/').pop();
          if (uploadedAssetUrls[backgroundFilename]) {
            // Use the uploaded background as thumbnail
            thumbnailUrl = uploadedAssetUrls[backgroundFilename];
          }
        }
        
        statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Uploading game to cloud database...</p>';
        
        // Upload game to Supabase database
        const gameData = {
          title: project.info.title,
          author: project.info.author,
          description: project.info.description,
          game_id: gameId,
          thumbnail_url: thumbnailUrl,
          config: {
            title: project.info.title,
            author: project.info.author,
            initialEvent: project.info.initialEvent
          },
          characters: charactersObj,
          events: eventsObj,
          is_public: true
        };
        
        const { data, error } = await supabase
          .from('games')
          .insert([gameData])
          .select()
          .single();
        
        if (error) {
          if (error.code === '23505') {
            throw new Error(`Game with ID "${gameId}" already exists. Please choose a different title or modify the game ID.`);
          }
          throw new Error(`Database error: ${error.message}`);
        }
        
        statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
        statusDiv.style.borderLeft = '4px solid #22c55e';
        statusDiv.innerHTML = `
          <h4 style="color: #22c55e; margin: 0 0 10px 0;">‚úÖ Cloud Import Successful!</h4>
          <p style="color: #22c55e; margin: 0 0 5px 0;">Game "${project.info.title}" uploaded to cloud</p>
          <p style="color: #ccc; margin: 0; font-size: 12px;">Game ID: ${gameId} | Assets uploaded: ${Object.keys(uploadedAssetUrls).length}</p>
          <p style="color: #ccc; margin: 5px 0 0 0; font-size: 12px;">Your game is now publicly available in the cloud library! üåä</p>
        `;
        
      } catch (error) {
        console.error('Cloud import error:', error);
        statusDiv.style.background = 'rgba(255, 107, 107, 0.2)';
        statusDiv.style.borderLeft = '4px solid #ff6b6b';
        statusDiv.innerHTML = `
          <h4 style="color: #ff6b6b; margin: 0 0 10px 0;">‚ùå Cloud Import Failed</h4>
          <p style="color: #ff6b6b; margin: 0;">${error.message}</p>
        `;
        throw error;
      }
    }

    function getMimeType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const mimeTypes = {
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
        'webp': 'image/webp',
        'svg': 'image/svg+xml',
        'bmp': 'image/bmp',
        'tiff': 'image/tiff',
        'mp3': 'audio/mpeg',
        'ogg': 'audio/ogg',
        'wav': 'audio/wav',
        'mp4': 'video/mp4',
        'webm': 'video/webm',
        'json': 'application/json',
        'txt': 'text/plain'
      };
      return mimeTypes[ext] || 'application/octet-stream';
    }

    async function deployGameToEngine(project, statusDivId, assetsOverride = null, gameIdOverride = null) {
      const statusDiv = document.getElementById(statusDivId);
      statusDiv.style.display = 'block';
      statusDiv.style.background = 'rgba(255, 165, 0, 0.2)';
      statusDiv.style.borderLeft = '4px solid #ffa500';
      statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚è≥ Validating game data...</p>';

      // Validation
      const errors = [];
      
      if (!project.info.id) errors.push('Game ID is required');
      if (!project.info.title) errors.push('Game title is required');
      if (!project.info.initialEvent) errors.push('Initial event is required');
      if (project.events.length === 0) errors.push('At least one event is required');
      
      // Check if initial event exists
      const hasInitialEvent = project.events.some(e => e.id === project.info.initialEvent);
      if (!hasInitialEvent) errors.push(`Initial event "${project.info.initialEvent}" not found in events`);

      // Validate event linkage
      const eventIds = new Set(project.events.map(e => e.id));
      project.events.forEach(event => {
        if (event.next && !eventIds.has(event.next)) {
          errors.push(`Event "${event.id}" links to non-existent event "${event.next}"`);
        }
        if (event.options) {
          event.options.forEach(opt => {
            if (opt.next && !eventIds.has(opt.next)) {
              errors.push(`Event "${event.id}" option links to non-existent event "${opt.next}"`);
            }
          });
        }
      });

      if (errors.length > 0) {
        statusDiv.style.background = 'rgba(255, 107, 107, 0.2)';
        statusDiv.style.borderLeft = '4px solid #ff6b6b';
        statusDiv.innerHTML = `
          <h4 style="color: #ff6b6b; margin: 0 0 10px 0;">‚ùå Validation Failed</h4>
          <ul style="color: #ff6b6b; margin: 0; padding-left: 20px;">
            ${errors.map(e => `<li>${e}</li>`).join('')}
          </ul>
          <p style="color: #ccc; margin: 10px 0 0 0; font-size: 12px;">Fix these issues and try again.</p>
        `;
        return;
      }

      statusDiv.innerHTML = '<p style="color: #ffa500; margin: 0;">‚úÖ Validation passed! Deploying game...</p>';

      try {
        // Create game data structure
        const gameData = {
          config: {
            title: project.info.title,
            author: project.info.author,
            initialEvent: project.info.initialEvent
          },
          characters: {},
          events: {}
        };

        project.characters.forEach(char => {
          gameData.characters[char.id] = {
            name: char.name,
            color: char.color,
            sprites: char.sprites.length > 0 ? char.sprites : undefined
          };
        });

        project.events.forEach(event => {
          gameData.events[event.id] = { ...event };
          delete gameData.events[event.id].id;
        });

        const gameId = gameIdOverride || project.info.id;

        // Store game data in localStorage
        localStorage.setItem(`vn_deployed_game_${gameId}`, JSON.stringify(gameData));
        
        // Get assets - either from override or from indexed DB
        let assetData = {};
        if (assetsOverride) {
          assetData = assetsOverride;
        } else {
          const assets = await getAllAssets();
          const gameAssets = assets.filter(a => a.gameId === gameId);
          gameAssets.forEach(asset => {
            const path = `${asset.type}/${asset.filename}`;
            assetData[path] = asset.data;
          });
        }
        
        localStorage.setItem(`vn_deployed_assets_${gameId}`, JSON.stringify(assetData));

        // Add to games list
        let gamesList = [];
        try {
          const gamesListData = localStorage.getItem('vn_games_list');
          if (gamesListData) {
            gamesList = JSON.parse(gamesListData);
          }
        } catch (e) {
          console.error('Error loading games list:', e);
        }

        // Check if game already exists
        const existingIndex = gamesList.findIndex(g => g.id === gameId);
        
        // Find a thumbnail
        let thumbnail = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIyNSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIyNSIgZmlsbD0iIzFhMWEyZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiNmZmQ3MDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5HYW1lPC90ZXh0Pjwvc3ZnPg==';
        for (const [path, data] of Object.entries(assetData)) {
          if (path.startsWith('backgrounds/') && data.startsWith('data:image')) {
            thumbnail = data;
            break;
          }
        }

        const gameListEntry = {
          id: gameId,
          title: project.info.title,
          description: project.info.description || 'No description provided',
          thumbnail: thumbnail,
          folder: `deployed/${gameId}`,
          deployed: true
        };

        if (existingIndex !== -1) {
          gamesList[existingIndex] = gameListEntry;
        } else {
          gamesList.push(gameListEntry);
        }

        localStorage.setItem('vn_games_list', JSON.stringify(gamesList));

        const assetCount = Object.keys(assetData).length;

        statusDiv.style.background = 'rgba(0, 255, 0, 0.2)';
        statusDiv.style.borderLeft = '4px solid #00ff00';
        statusDiv.innerHTML = `
          <h4 style="color: #00ff00; margin: 0 0 10px 0;">‚úÖ Deployment Successful!</h4>
          <p style="color: #ccc; margin: 0;">Your game has been added to Novellium.</p>
          <p style="color: #ccc; margin: 10px 0 0 0;">
            <strong>Game ID:</strong> ${gameId}<br>
            <strong>Title:</strong> ${project.info.title}<br>
            <strong>Events:</strong> ${project.events.length}<br>
            <strong>Characters:</strong> ${project.characters.length}<br>
            <strong>Assets:</strong> ${assetCount}
          </p>
          <button class="btn btn-primary" onclick="window.location.href='index.html'" style="margin-top: 15px; width: 100%;">
            üéÆ Go to Library and Play
          </button>
        `;

      } catch (error) {
        console.error('Deployment error:', error);
        statusDiv.style.background = 'rgba(255, 107, 107, 0.2)';
        statusDiv.style.borderLeft = '4px solid #ff6b6b';
        statusDiv.innerHTML = `
          <h4 style="color: #ff6b6b; margin: 0 0 10px 0;">‚ùå Deployment Failed</h4>
          <p style="color: #ff6b6b; margin: 0;">${error.message}</p>
        `;
      }
    }

    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert(`${filename} downloaded!`);
    }

    // ===== ASSET MANAGEMENT =====
    
    // Store assets in IndexedDB for larger storage capacity
    let assetsDB;
    
    function initAssetsDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('VNBuilderAssets', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          assetsDB = request.result;
          resolve(assetsDB);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('assets')) {
            const objectStore = db.createObjectStore('assets', { keyPath: 'id', autoIncrement: true });
            objectStore.createIndex('type', 'type', { unique: false });
            objectStore.createIndex('filename', 'filename', { unique: false });
            objectStore.createIndex('gameId', 'gameId', { unique: false });
          }
        };
      });
    }

    function saveAssetToDB(asset) {
      return new Promise((resolve, reject) => {
        const transaction = assetsDB.transaction(['assets'], 'readwrite');
        const objectStore = transaction.objectStore('assets');
        const request = objectStore.add(asset);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function getAllAssets() {
      return new Promise((resolve, reject) => {
        const transaction = assetsDB.transaction(['assets'], 'readonly');
        const objectStore = transaction.objectStore('assets');
        const request = objectStore.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function deleteAssetFromDB(id) {
      return new Promise((resolve, reject) => {
        const transaction = assetsDB.transaction(['assets'], 'readwrite');
        const objectStore = transaction.objectStore('assets');
        const request = objectStore.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // Upload assets
    document.getElementById('btn-upload-assets').addEventListener('click', async () => {
      const fileInput = document.getElementById('asset-upload');
      const assetType = document.getElementById('asset-type').value;
      const gameId = projectData.info.id || 'default';
      
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select files to upload');
        return;
      }

      const uploadedCount = fileInput.files.length;
      
      for (const file of fileInput.files) {
        const reader = new FileReader();
        
        await new Promise((resolve) => {
          reader.onload = async (e) => {
            const asset = {
              filename: file.name,
              type: assetType,
              gameId: gameId,
              mimeType: file.type,
              size: file.size,
              data: e.target.result,
              uploadedAt: new Date().toISOString()
            };
            
            await saveAssetToDB(asset);
            resolve();
          };
          reader.readAsDataURL(file);
        });
      }
      
      alert(`${uploadedCount} file(s) uploaded successfully!`);
      fileInput.value = '';
      refreshAssetsList();
    });

    // Refresh assets list
    async function refreshAssetsList() {
      const assets = await getAllAssets();
      const gameId = projectData.info.id || 'default';
      const gameAssets = assets.filter(a => a.gameId === gameId);
      
      const list = document.getElementById('assets-list');
      
      if (gameAssets.length === 0) {
        list.innerHTML = '<p style="color: #999;">No assets uploaded yet</p>';
        return;
      }

      list.innerHTML = '';
      
      // Group by type
      const grouped = {};
      gameAssets.forEach(asset => {
        if (!grouped[asset.type]) grouped[asset.type] = [];
        grouped[asset.type].push(asset);
      });

      for (const [type, items] of Object.entries(grouped)) {
        const section = document.createElement('div');
        section.style.marginBottom = '20px';
        
        const header = document.createElement('h4');
        header.style.color = '#ffd700';
        header.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} (${items.length})`;
        section.appendChild(header);

        items.forEach(asset => {
          const item = document.createElement('div');
          item.className = 'list-item';
          
          const sizeKB = (asset.size / 1024).toFixed(1);
          
          item.innerHTML = `
            <div class="list-item-info">
              <h4>${asset.filename}</h4>
              <p>${sizeKB} KB | ${new Date(asset.uploadedAt).toLocaleDateString()}</p>
            </div>
            <div class="list-item-actions">
              <button class="btn btn-secondary btn-preview-asset" data-id="${asset.id}">üëÅÔ∏è Preview</button>
              <button class="btn btn-secondary btn-download-asset" data-id="${asset.id}">üíæ Download</button>
              <button class="btn btn-danger btn-delete-asset" data-id="${asset.id}">Delete</button>
            </div>
          `;
          section.appendChild(item);
        });

        list.appendChild(section);
      }

      // Attach event listeners
      document.querySelectorAll('.btn-preview-asset').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = parseInt(btn.dataset.id);
          const asset = gameAssets.find(a => a.id === id);
          
          if (asset.mimeType.startsWith('image/')) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
              <div style="max-width: 90%; max-height: 90%; position: relative;">
                <img src="${asset.data}" style="max-width: 100%; max-height: 90vh; border-radius: 8px;">
                <button style="position: absolute; top: 10px; right: 10px; padding: 10px 20px; background: #ff6b6b; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 16px;">Close</button>
              </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('button').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
              if (e.target === modal) modal.remove();
            });
          } else {
            alert('Preview not available for this file type');
          }
        });
      });

      document.querySelectorAll('.btn-download-asset').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = parseInt(btn.dataset.id);
          const asset = gameAssets.find(a => a.id === id);
          
          const link = document.createElement('a');
          link.href = asset.data;
          link.download = asset.filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      });

      document.querySelectorAll('.btn-delete-asset').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (confirm('Delete this asset?')) {
            const id = parseInt(btn.dataset.id);
            await deleteAssetFromDB(id);
            refreshAssetsList();
          }
        });
      });
    }

    // Download all assets as individual files
    document.getElementById('btn-download-all-assets').addEventListener('click', async () => {
      const assets = await getAllAssets();
      const gameId = projectData.info.id || 'default';
      const gameAssets = assets.filter(a => a.gameId === gameId);
      
      if (gameAssets.length === 0) {
        alert('No assets to download');
        return;
      }

      // Download each asset individually
      for (const asset of gameAssets) {
        await new Promise(resolve => setTimeout(resolve, 100)); // Small delay between downloads
        
        const link = document.createElement('a');
        link.href = asset.data;
        link.download = `${asset.type}/${asset.filename}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      alert(`Downloaded ${gameAssets.length} asset(s)!\nOrganize them into: backgrounds/, characters/, music/, sounds/ folders.`);
    });

    // Initialize
    // Load navbar component
    async function loadNavbar() {
      try {
        const response = await fetch('scripts/navbar.html');
        const html = await response.text();
        document.getElementById('navbar-container').innerHTML = html;
        
        // Update page title - keep the gradient span
        const titleElement = document.getElementById('current-page-title');
        if (titleElement) {
          titleElement.innerHTML = '<span class="brand-gradient">Novellium</span> Builder';
        }
        
        // Hide save button on builder page
        const btnSave = document.getElementById('btn-save');
        if (btnSave) {
          btnSave.style.display = 'none';
        }
        
        // Setup builder-specific navigation - highlight builder button
        const btnBuilder = document.getElementById('btn-builder');
        if (btnBuilder) {
          btnBuilder.classList.add('primary');
        }
        
        const btnHome = document.getElementById('btn-home');
        if (btnHome) {
          btnHome.classList.remove('primary');
        }

        // Setup settings panel functionality
        const btnMenu = document.getElementById('btn-menu');
        if (btnMenu) {
          btnMenu.addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('slide-menu');
            if (menu) {
              menu.classList.add('active');
            }
          });
        }
      } catch (error) {
        console.error('Failed to load navbar:', error);
      }
    }

    async function initialize() {
      console.log('Initializing builder...');
      await loadNavbar(); // Load navbar first
      await waitForJSZip();
      console.log('JSZip loaded');
      setupEventListeners();
      console.log('Event listeners set up');
      
      // Initialize mode toggle visibility (show only for project/characters/events)
      const modeToggle = document.querySelector('.mode-toggle');
      if (currentSection === 'project' || currentSection === 'characters' || currentSection === 'events') {
        modeToggle.style.display = 'flex';
      } else {
        modeToggle.style.display = 'none';
      }
      
      await initAssetsDB();
      console.log('Assets DB initialized');
      loadProject();
      console.log('Project loaded');
      refreshAssetsList();
      console.log('Assets list refreshed');
    }

    initialize();
  </script>
  </div> <!-- Close builder-content -->
  </div> <!-- Close builder-container -->

  <!-- Universal Settings Panel (matches index.html exactly) -->
  <div id="slide-menu" class="slide-menu">
    <div class="menu-header">
      <h3>‚öôÔ∏è Settings</h3>
      <button id="close-menu" class="close-btn">‚úï</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <h4>üîä Audio</h4>
        <div class="setting-item">
          <label for="master-volume">Master Volume:</label>
          <input type="range" id="master-volume" min="0" max="100" value="70">
          <span id="master-volume-value">70%</span>
        </div>
      </div>

      <div class="settings-section">
        <h4>‚å®Ô∏è Text Speed</h4>
        <div class="setting-item">
          <label for="typewriter-speed">Typewriter Effect Speed:</label>
          <input type="range" id="typewriter-speed" min="1" max="10" value="5">
          <span id="typewriter-speed-value">5</span>
        </div>
      </div>

      <div class="settings-section">
        <h4>üé® Theme Colors</h4>
        
        <div class="setting-item">
          <label for="primary-color">Primary Color (Gold Accents):</label>
          <input type="color" id="primary-color" value="#ffd700">
          <span class="color-preview" id="primary-preview">#ffd700</span>
        </div>
        
        <div class="setting-item">
          <label for="secondary-color">Secondary Color (Highlights):</label>
          <input type="color" id="secondary-color" value="#ff6b6b">
          <span class="color-preview" id="secondary-preview">#ff6b6b</span>
        </div>
        
        <div class="setting-item">
          <label for="background-color">Background Color:</label>
          <input type="color" id="background-color" value="#1a1a2e">
          <span class="color-preview" id="background-preview">#1a1a2e</span>
        </div>
        
        <div class="setting-item">
          <label for="text-color">Text Color:</label>
          <input type="color" id="text-color" value="#ffffff">
          <span class="color-preview" id="text-preview">#ffffff</span>
        </div>
      </div>

      <div class="settings-section">
        <h4>üíæ Data Management</h4>
        <div class="setting-item">
          <button id="btn-export-settings" class="settings-btn export">üì§ Export Settings</button>
          <button id="btn-import-settings" class="settings-btn import">üì• Import Settings</button>
        </div>
        <div class="setting-item">
          <button id="btn-export-saves" class="settings-btn export">üíæ Export All Saves</button>
          <button id="btn-import-saves" class="settings-btn import">üìÇ Import Saves</button>
          <input type="file" id="import-saves-input" accept=".vnbackup,.vnsave" style="display: none;" multiple>
        </div>
        <div class="setting-item">
          <button id="btn-reset-settings" class="settings-btn reset">üîÑ Reset Settings</button>
        </div>
      </div>

      <div class="settings-section">
        <h4>üìñ Help</h4>
        <div class="setting-item">
          <button id="btn-documentation" class="settings-btn help">üìö Documentation</button>
        </div>
      </div>
      
      <div class="settings-actions">
        <button id="btn-apply-settings" class="settings-btn apply">‚úì Apply Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Import SaveManager for save file management
    import('./src/managers/SaveManager.js').then(module => {
      window.saveManager = new module.SaveManager();
    }).catch(error => {
      console.error('Failed to load SaveManager:', error);
      // Create a fallback object with alert messages
      window.saveManager = {
        exportAllSaves: () => alert('Save export not available in builder mode'),
        importAllSaves: () => alert('Save import not available in builder mode'),
        importSaveFromFile: () => alert('Save import not available in builder mode')
      };
    });

    // Universal Settings functions (shared with index.html)
    const defaultSettings = {
      masterVolume: 70,
      typewriterSpeed: 5,
      colors: {
        primary: '#ffd700',
        secondary: '#ff6b6b',
        background: '#1a1a2e',
        text: '#ffffff'
      }
    };

    // Load saved settings from localStorage
    function loadSettings() {
      const saved = localStorage.getItem('novellium_universal_settings');
      if (saved) {
        const settings = JSON.parse(saved);
        document.getElementById('master-volume').value = settings.masterVolume || defaultSettings.masterVolume;
        document.getElementById('typewriter-speed').value = settings.typewriterSpeed || defaultSettings.typewriterSpeed;
        document.getElementById('primary-color').value = settings.colors.primary || defaultSettings.colors.primary;
        document.getElementById('secondary-color').value = settings.colors.secondary || defaultSettings.colors.secondary;
        document.getElementById('background-color').value = settings.colors.background || defaultSettings.colors.background;
        document.getElementById('text-color').value = settings.colors.text || defaultSettings.colors.text;
        updateSettingsValues();
        applySettings(settings);
      } else {
        updateSettingsValues();
        applySettings(defaultSettings);
      }
    }

    // Update setting value displays
    function updateSettingsValues() {
      document.getElementById('master-volume-value').textContent = document.getElementById('master-volume').value + '%';
      document.getElementById('typewriter-speed-value').textContent = document.getElementById('typewriter-speed').value;
      document.getElementById('primary-preview').textContent = document.getElementById('primary-color').value;
      document.getElementById('secondary-preview').textContent = document.getElementById('secondary-color').value;
      document.getElementById('background-preview').textContent = document.getElementById('background-color').value;
      document.getElementById('text-preview').textContent = document.getElementById('text-color').value;
    }

    // Apply settings to both pages
    function applySettings(settings) {
      // Apply colors to CSS variables
      document.documentElement.style.setProperty('--primary-color', settings.colors.primary);
      document.documentElement.style.setProperty('--secondary-color', settings.colors.secondary);
      document.documentElement.style.setProperty('--background-color', settings.colors.background);
      document.documentElement.style.setProperty('--text-color', settings.colors.text);
      
      // Create dynamic CSS overrides for both pages
      let dynamicStyle = document.getElementById('dynamic-universal-theme');
      if (!dynamicStyle) {
        dynamicStyle = document.createElement('style');
        dynamicStyle.id = 'dynamic-universal-theme';
        document.head.appendChild(dynamicStyle);
      }
      
      dynamicStyle.textContent = `
        /* Universal theme overrides for both index and builder */
        .brand-gradient,
        .vertical-game-card.selected,
        .carousel-game-card.selected,
        .menu-header h3,
        .sidebar-header h2,
        .vertical-game-info h3,
        .welcome-content h1,
        .game-options-header h2,
        .saves-section h3,
        .settings-section h4,
        .section-header h2,
        .builder-nav li.active,
        .nav-btn.primary,
        h1, h2, h3, h4 {
          color: ${settings.colors.primary} !important;
        }
        
        .vertical-game-card.selected,
        .vertical-game-card:hover,
        .builder-nav li:hover,
        .builder-nav li.active,
        input:checked + .toggle-slider {
          border-color: ${settings.colors.primary} !important;
        }
        
        /* Button colors */
        .game-action-btn.new-game,
        .settings-btn.apply,
        .nav-btn.primary,
        .btn-primary {
          background: linear-gradient(135deg, ${settings.colors.primary}, ${settings.colors.secondary}) !important;
          color: ${settings.colors.background} !important;
        }
        
        .game-action-btn.new-game:hover,
        .settings-btn.apply:hover,
        .btn-primary:hover {
          box-shadow: 0 6px 20px ${settings.colors.primary}66 !important;
        }
        
        /* Background colors */
        body,
        .start-screen,
        .content-area,
        .builder-container,
        .slide-menu {
          background-color: ${settings.colors.background} !important;
        }
        
        /* Text colors */
        body,
        .content-area,
        .slide-menu,
        .builder-container {
          color: ${settings.colors.text} !important;
        }
        
        /* Brand gradient override */
        .brand-gradient {
          background: linear-gradient(45deg, ${settings.colors.primary}, ${settings.colors.secondary}) !important;
          -webkit-background-clip: text !important;
          -webkit-text-fill-color: transparent !important;
          background-clip: text !important;
        }
        
        /* Navbar highlighting */
        .nav-btn.primary {
          background: linear-gradient(135deg, ${settings.colors.primary}, ${settings.colors.secondary}) !important;
          color: ${settings.colors.background} !important;
          border-color: ${settings.colors.primary} !important;
        }
      `;
      
      // Save settings
      const settingsToSave = {
        masterVolume: settings.masterVolume,
        typewriterSpeed: settings.typewriterSpeed,
        colors: settings.colors
      };
      localStorage.setItem('novellium_universal_settings', JSON.stringify(settingsToSave));
    }

    // Collect current settings from form
    function getCurrentSettings() {
      return {
        masterVolume: parseInt(document.getElementById('master-volume').value),
        typewriterSpeed: parseInt(document.getElementById('typewriter-speed').value),
        colors: {
          primary: document.getElementById('primary-color').value,
          secondary: document.getElementById('secondary-color').value,
          background: document.getElementById('background-color').value,
          text: document.getElementById('text-color').value
        }
      };
    }

    // Export settings
    function exportSettings() {
      const settings = getCurrentSettings();
      const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'novellium-settings.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('Settings exported successfully!');
    }

    // Import settings
    function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const settings = JSON.parse(e.target.result);
              document.getElementById('master-volume').value = settings.masterVolume || defaultSettings.masterVolume;
              document.getElementById('typewriter-speed').value = settings.typewriterSpeed || defaultSettings.typewriterSpeed;
              document.getElementById('primary-color').value = settings.colors.primary || defaultSettings.colors.primary;
              document.getElementById('secondary-color').value = settings.colors.secondary || defaultSettings.colors.secondary;
              document.getElementById('background-color').value = settings.colors.background || defaultSettings.colors.background;
              document.getElementById('text-color').value = settings.colors.text || defaultSettings.colors.text;
              updateSettingsValues();
              applySettings(settings);
              alert('Settings imported successfully!');
            } catch (error) {
              alert('Error importing settings: ' + error.message);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    // Reset settings
    function resetSettings() {
      if (confirm('Reset all settings to default values?')) {
        document.getElementById('master-volume').value = defaultSettings.masterVolume;
        document.getElementById('typewriter-speed').value = defaultSettings.typewriterSpeed;
        document.getElementById('primary-color').value = defaultSettings.colors.primary;
        document.getElementById('secondary-color').value = defaultSettings.colors.secondary;
        document.getElementById('background-color').value = defaultSettings.colors.background;
        document.getElementById('text-color').value = defaultSettings.colors.text;
        updateSettingsValues();
        applySettings(defaultSettings);
        alert('Settings reset to defaults!');
      }
    }

    function closeSettings() {
      document.getElementById('slide-menu').classList.remove('active');
    }

    // Close menu handler
    document.getElementById('close-menu').onclick = () => {
      document.getElementById('slide-menu').classList.remove('active');
    };

    // Settings input event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Load settings on page load
      loadSettings();
      
      // Range input listeners
      document.getElementById('master-volume').addEventListener('input', updateSettingsValues);
      document.getElementById('typewriter-speed').addEventListener('input', updateSettingsValues);
      
      // Color input listeners
      document.getElementById('primary-color').addEventListener('input', updateSettingsValues);
      document.getElementById('secondary-color').addEventListener('input', updateSettingsValues);
      document.getElementById('background-color').addEventListener('input', updateSettingsValues);
      document.getElementById('text-color').addEventListener('input', updateSettingsValues);
      
      // Button listeners
      document.getElementById('btn-apply-settings').onclick = () => {
        const settings = getCurrentSettings();
        applySettings(settings);
        alert('Settings applied!');
        document.getElementById('slide-menu').classList.remove('active');
      };
      
      document.getElementById('btn-export-settings').onclick = exportSettings;
      document.getElementById('btn-import-settings').onclick = importSettings;
      document.getElementById('btn-reset-settings').onclick = resetSettings;
      
      // Save management functionality
      document.getElementById('btn-export-saves').onclick = async () => {
        try {
          if (window.saveManager && window.saveManager.exportAllSaves) {
            await window.saveManager.exportAllSaves();
            alert('All saves exported successfully!');
          } else {
            alert('Save export functionality not available');
          }
        } catch (error) {
          console.error('Export failed:', error);
          alert('Failed to export saves');
        }
      };

      document.getElementById('btn-import-saves').onclick = () => {
        document.getElementById('import-saves-input').click();
      };

      document.getElementById('import-saves-input').onchange = async (e) => {
        const files = e.target.files;
        if (!files.length) return;

        let imported = 0;
        let failed = 0;

        for (const file of files) {
          try {
            if (window.saveManager) {
              if (file.name.endsWith('.vnbackup')) {
                // Import bundle of saves
                const result = await window.saveManager.importAllSaves(file);
                imported += result.imported;
              } else if (file.name.endsWith('.vnsave')) {
                // Import single save
                await window.saveManager.importSaveFromFile(file);
                imported++;
              }
            } else {
              throw new Error('SaveManager not available');
            }
          } catch (error) {
            console.error('Import failed for', file.name, error);
            failed++;
          }
        }

        if (imported > 0) {
          alert(`Imported ${imported} save(s)${failed > 0 ? `, ${failed} failed` : ''}`);
        } else {
          alert('No saves imported');
        }

        // Reset file input
        e.target.value = '';
      };
      
      document.getElementById('btn-documentation').onclick = () => {
        try {
          window.open('README.pdf', '_blank');
        } catch (error) {
          alert('Documentation PDF not found. Please ensure README.pdf is in the project directory.');
        }
      };
    });

    // Close settings when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('slide-menu');
      const menuBtn = document.getElementById('btn-menu');
      
      if (menu && menuBtn && !menu.contains(e.target) && !menuBtn.contains(e.target)) {
        menu.classList.remove('active');
      }
    });
  </script>
</body>
</html>
