<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Novellium</title>
  <link rel="icon" type="image/png" href="./NovelliumLogo/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="./NovelliumLogo/favicon.svg" />
  <link rel="shortcut icon" href="./NovelliumLogo/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="./NovelliumLogo/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Novellium" />
  <link rel="manifest" href="./NovelliumLogo/site.webmanifest" />
  <link rel="stylesheet" href="styles.css?v=4.0">
  <style id="dynamic-theme">
    /* Dynamic theme colors applied via JavaScript */
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Navbar will be loaded here -->
    <div id="navbar-container"></div>
    
    <!-- Settings panel (right side) -->
    <div id="slide-menu" class="slide-menu">
      <div class="menu-header">
        <h3>⚙️ Settings</h3>
        <button id="close-menu" class="close-btn">✕</button>
      </div>
      
      <!-- Universal Settings content -->
      <div class="settings-content">
        <div class="settings-section">
          <h4>🔊 Audio</h4>
          <div class="setting-item">
            <label for="master-volume">Master Volume:</label>
            <input type="range" id="master-volume" min="0" max="100" value="70">
            <span id="master-volume-value">70%</span>
          </div>
        </div>

        <div class="settings-section">
          <h4>⌨️ Text Speed</h4>
          <div class="setting-item">
            <label for="typewriter-speed">Typewriter Effect Speed:</label>
            <input type="range" id="typewriter-speed" min="1" max="10" value="5">
            <span id="typewriter-speed-value">5</span>
          </div>
        </div>

        <div class="settings-section">
          <h4>🎨 Theme Colors</h4>
          
          <div class="setting-item">
            <label for="primary-color">Primary Color (Gold Accents):</label>
            <input type="color" id="primary-color" value="#ffd700">
            <span class="color-preview" id="primary-preview">#ffd700</span>
          </div>
          
          <div class="setting-item">
            <label for="secondary-color">Secondary Color (Highlights):</label>
            <input type="color" id="secondary-color" value="#ff6b6b">
            <span class="color-preview" id="secondary-preview">#ff6b6b</span>
          </div>
          
          <div class="setting-item">
            <label for="background-color">Background Color:</label>
            <input type="color" id="background-color" value="#1a1a2e">
            <span class="color-preview" id="background-preview">#1a1a2e</span>
          </div>
          
          <div class="setting-item">
            <label for="text-color">Text Color:</label>
            <input type="color" id="text-color" value="#ffffff">
            <span class="color-preview" id="text-preview">#ffffff</span>
          </div>
        </div>

        <div class="settings-section">
          <h4>💾 Data Management</h4>
          <div class="setting-item">
            <button id="btn-export-settings" class="settings-btn export">📤 Export Settings</button>
            <button id="btn-import-settings" class="settings-btn import">📥 Import Settings</button>
          </div>
          <div class="setting-item">
            <button id="btn-export-saves" class="settings-btn export">💾 Export All Saves</button>
            <button id="btn-import-saves" class="settings-btn import">📂 Import Saves</button>
            <input type="file" id="import-saves-input" accept=".vnbackup,.vnsave" style="display: none;" multiple>
          </div>
          <div class="setting-item">
            <button id="btn-reset-settings" class="settings-btn reset">🔄 Reset Settings</button>
          </div>
        </div>

        <div class="settings-section">
          <h4>📖 Help</h4>
          <div class="setting-item">
            <button id="btn-documentation" class="settings-btn help">📚 Documentation</button>
          </div>
        </div>
        
        <div class="settings-actions">
          <button id="btn-apply-settings" class="settings-btn apply">✓ Apply Changes</button>
        </div>
      </div>
    </div>
    
    <div id="feedback-toast" class="feedback-toast"></div>
    
    <div id="game-container" class="game-container">
      <!-- Start screen will be loaded by JavaScript -->
    </div>
  </div>

  <script type="module">
    import { VisualNovelEngine } from './src/engine.js?v=2.1';
    import { SaveManager } from './src/managers/SaveManager.js?v=2.1';

    let engine = null;
    let currentGame = null;
    let gamesList = [];
    let saveManager = new SaveManager(); // Create a shared save manager
    
    console.log('SaveManager loaded:', saveManager);
    console.log('SaveManager has exportAllSaves?', typeof saveManager.exportAllSaves);
    console.log('Auto-backup initial state:', saveManager.autoBackup);

    // Feedback system
    function showFeedback(message, type = 'success') {
      const toast = document.getElementById('feedback-toast');
      toast.textContent = message;
      toast.className = `feedback-toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load games list (now includes cloud games)
    async function loadGamesList() {
      try {
        // Import cloud game manager
        const { cloudGameManager } = await import('./src/managers/CloudGameManager.js');
        
        // Load all games (local + cloud)
        const allGames = await cloudGameManager.getAllGames();
        
        // Convert to the expected format
        gamesList = {
          games: allGames.map(game => ({
            id: game.id || game.gameFolder,
            title: game.title,
            author: game.author,
            description: game.description || '',
            gameFolder: game.gameFolder,
            thumbnail: game.thumbnail,
            source: game.source,
            isLocal: game.isLocal,
            cloudId: game.cloudId,
            downloadCount: game.downloadCount || 0,
            rating: game.rating || 0,
            createdAt: game.createdAt,
            updatedAt: game.updatedAt
          }))
        };
        
        console.log(`Games loaded: ${gamesList.games.length} total (${gamesList.games.filter(g => g.source === 'local').length} local, ${gamesList.games.filter(g => g.source === 'cloud').length} cloud)`);
        
        // Show cloud status
        const cloudGames = gamesList.games.filter(g => g.source === 'cloud');
        if (cloudGames.length > 0) {
          showFeedback(`📡 Loaded ${cloudGames.length} games from cloud`, 'success');
        }
        
      } catch (error) {
        console.error('Failed to load games list:', error);
        
        // Fallback to local-only loading
        try {
          console.log('Falling back to local games only...');
          const response = await fetch(`./config/games-list.json?v=${Date.now()}`);
          const localGamesList = await response.json();
          
          // Mark all as local games
          gamesList = {
            games: localGamesList.games.map(game => ({
              ...game,
              source: 'local',
              isLocal: true
            }))
          };
          
          // Merge with deployed games from localStorage (legacy support)
          const deployedGames = localStorage.getItem('vn_games_list');
          if (deployedGames) {
            try {
              const deployed = JSON.parse(deployedGames);
              if (Array.isArray(deployed) && deployed.length > 0) {
                gamesList.games = [...gamesList.games, ...deployed.map(game => ({
                  ...game,
                  source: 'deployed',
                  isLocal: false
                }))];
                console.log('Added', deployed.length, 'deployed games from localStorage');
              }
            } catch (e) {
              console.error('Error parsing deployed games:', e);
            }
          }
          
          console.log('Local games loaded successfully');
          showFeedback('📡 Cloud unavailable - using local games only', 'warning');
          
        } catch (fallbackError) {
          console.error('Fallback failed too:', fallbackError);
          showFeedback('Failed to load games list', 'error');
          gamesList = { games: [] };
        }
      }
    }

    // Populate games in vertical sidebar
    let selectedGameOnStart = null;
    
    function populateGamesCarousel() {
      const gamesListVertical = document.getElementById('games-list-vertical');
      
      if (!gamesListVertical) {
        console.error('games-list-vertical element not found');
        return;
      }
      
      if (!gamesList || !gamesList.games) {
        console.error('No games in gamesList:', gamesList);
        return;
      }
      
      gamesListVertical.innerHTML = '';
      
      console.log('Populating', gamesList.games.length, 'games');
      
      gamesList.games.forEach(game => {
        const gameCard = document.createElement('div');
        gameCard.className = 'vertical-game-card';
        gameCard.dataset.gameFolder = game.gameFolder || game.folder;
        
        // Add source indicator
        const sourceIcon = game.source === 'cloud' ? '☁️' : 
                          game.source === 'deployed' ? '📦' : '📁';
        const sourceText = game.source === 'cloud' ? 'Cloud' : 
                          game.source === 'deployed' ? 'Deployed' : 'Local';
        
        gameCard.innerHTML = `
          <div class="vertical-game-thumbnail">
            <img src="${game.thumbnail || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2210%22%3ENo Image%3C/text%3E%3C/svg%3E'}" alt="${game.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2210%22%3ENo Image%3C/text%3E%3C/svg%3E'">
            <div class="game-source-badge" title="${sourceText} game">${sourceIcon}</div>
          </div>
          <div class="vertical-game-info">
            <h3>${game.title}</h3>
            <p style="color: #ffd700; font-size: 0.85em; margin: 5px 0;">By ${game.author || 'Anonymous'}</p>
            <p>${game.description || 'No description available.'}</p>
            ${game.downloadCount ? `<p style="color: #00d4ff; font-size: 0.8em;">📥 ${game.downloadCount} downloads</p>` : ''}
            ${game.rating && game.rating > 0 ? `<p style="color: #ffd700; font-size: 0.8em;">⭐ ${game.rating}/5</p>` : ''}
          </div>
        `;
        
        // Click card to show game options
        gameCard.addEventListener('click', () => {
          selectGameOnStart(game);
        });
        
        gamesListVertical.appendChild(gameCard);
      });
    }

    // Select a game on start screen to show options
    function selectGameOnStart(game) {
      selectedGameOnStart = game;
      
      // Update card selection
      document.querySelectorAll('.vertical-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-game-folder="${game.folder}"]`).classList.add('selected');
      
      // Hide welcome content, show game options
      document.getElementById('welcome-content').style.display = 'none';
      const optionsPanel = document.getElementById('game-options-panel');
      optionsPanel.style.display = 'block';
      
      // Update game info
      document.getElementById('selected-game-title').textContent = game.title;
      const authorElement = document.getElementById('selected-game-author');
      if (authorElement) {
        authorElement.textContent = `By ${game.author || 'Anonymous'}`;
        authorElement.style.display = 'block';
      }
      document.getElementById('selected-game-description').textContent = game.description;
      
      // Setup play new button
      document.getElementById('btn-play-new').onclick = () => {
        loadGame(game.folder);
      };
      
      // Load saves for this game
      loadStartSavesForGame(game.folder);
    }

    // Load saves for game on start screen
    function loadStartSavesForGame(gameFolder) {
      console.log('=== loadStartSavesForGame called ===');
      console.log('GameFolder:', gameFolder);
      
      // Use the shared save manager instead of creating engine
      const allSaves = saveManager.getSaveSlots();
      console.log('All saves from localStorage:', allSaves);
      
      const gameSaves = allSaves.filter(save => {
        console.log(`Checking save: ${save.name}, folder: ${save.gameFolder} === ${gameFolder}?`, save.gameFolder === gameFolder);
        return save.gameFolder === gameFolder;
      });
      console.log('Filtered game saves:', gameSaves);
      
      const savesList = document.getElementById('start-saves-list');
      
      if (!savesList) {
        console.error('start-saves-list element not found!');
        return;
      }
      
      if (gameSaves.length === 0) {
        savesList.innerHTML = '<p class="no-saves">No saves for this game yet</p>';
        return;
      }
      
      savesList.innerHTML = '';
      gameSaves.forEach(save => {
        const item = document.createElement('div');
        item.className = 'start-save-item';
        const date = new Date(save.timestamp).toLocaleString();
        
        item.innerHTML = `
          <div class="save-info">
            <span class="save-name">${save.name}</span>
            <span class="save-date">${date}</span>
          </div>
          <div class="save-actions">
            <button onclick="loadSaveAndPlay('${save.name}')" class="load-save-btn">Load</button>
            <button onclick="deleteStartSave('${save.name}')" class="delete-save-btn">×</button>
          </div>
        `;
        savesList.appendChild(item);
      });
    }

    // Delete save from start screen
    window.deleteStartSave = function(saveName) {
      if (confirm(`Delete "${saveName}"?`)) {
        saveManager.deleteSave(saveName);
        if (selectedGameOnStart) {
          loadStartSavesForGame(selectedGameOnStart.folder);
        }
        showFeedback(`Deleted: ${saveName}`);
      }
    };

    // OLD - Close saves panel (not used with new vertical layout)
    /*
    document.getElementById('close-saves-panel').onclick = () => {
      document.getElementById('saves-panel').style.display = 'none';
      document.querySelectorAll('.carousel-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      selectedGameOnStart = null;
    };
    */

    // Populate menu games bar with cards
    let selectedGameForSaves = null;
    
    // OLD FUNCTION - Not used with new vertical layout
    /*
    function populateMenuGames() {
      const menuGamesBar = document.getElementById('menu-games-bar');
      menuGamesBar.innerHTML = '';
      
      gamesList.games.forEach(game => {
        const card = document.createElement('div');
        card.className = 'menu-game-card';
        card.dataset.gameFolder = game.folder;
        card.innerHTML = `
          <div class="menu-game-thumbnail">
            <img src="${game.thumbnail}" alt="${game.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'">
          </div>
          <div class="menu-game-info">
            <h5>${game.title}</h5>
            <button class="play-game-btn" onclick="loadGame('${game.folder}')">▶ Play</button>
          </div>
        `;
        
        // Click card to show saves
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('play-game-btn')) {
            selectGameForSaves(game);
          }
        });
        
        menuGamesBar.appendChild(card);
      });
    }
    */

    // Select a game to view its saves
    // OLD FUNCTIONS - Not used with new vertical layout
    /*
    function selectGameForSaves(game) {
      selectedGameForSaves = game;
      
      // Update UI
      document.querySelectorAll('.menu-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-game-folder="${game.folder}"]`).classList.add('selected');
      
      // Show saves section
      document.getElementById('menu-saves-section').style.display = 'block';
      document.getElementById('selected-game-title').textContent = `${game.title} - Saves`;
      document.getElementById('btn-new-save').style.display = 'block';
      
      // Load saves for this game
      loadMenuSavesForGame(game.folder);
    }

    // Load and populate save files for specific game
    function loadMenuSavesForGame(gameFolder) {
      if (!engine) {
        engine = new VisualNovelEngine(document.getElementById('game-container'));
      }
      
      const allSaves = engine.saveManager.getSaveSlots();
      const gameSaves = allSaves.filter(save => save.gameFolder === gameFolder);
      const menuSavesList = document.getElementById('menu-saves-list');
      
      if (gameSaves.length === 0) {
        menuSavesList.innerHTML = '<p class="no-saves">No saves for this game yet</p>';
        return;
      }
      
      menuSavesList.innerHTML = '';
      gameSaves.forEach(save => {
        const item = document.createElement('div');
        item.className = 'save-item';
        const date = new Date(save.timestamp).toLocaleString();
        
        item.innerHTML = `
          <div class="save-info">
            <span class="save-name">${save.name}</span>
            <span class="save-date">${date}</span>
          </div>
          <div class="save-actions">
            <button onclick="loadSaveAndPlay('${save.name}')" class="load-save-btn">Load</button>
            <button onclick="deleteSave('${save.name}')" class="delete-save-btn">Delete</button>
          </div>
        `;
        menuSavesList.appendChild(item);
      });
    }
    */

    // Load a specific game
    window.loadGame = async function(gamePath) {
      try {
        showFeedback('Loading game...', 'info');
        
        // Hide start screen
        const startScreen = document.getElementById('start-screen');
        if (startScreen) {
          startScreen.style.display = 'none';
        }
        
        // Close menu
        document.getElementById('slide-menu').classList.remove('active');
        
        // Only create new engine if it doesn't exist or game changed
        if (!engine || currentGame !== gamePath) {
          engine = new VisualNovelEngine(document.getElementById('game-container'));
          currentGame = gamePath;
          await engine.loadGame(gamePath);
        }
        
        // Update nav title to show current game
        const gameInfo = gamesList.games.find(g => g.folder === gamePath);
        const gameTitle = gameInfo ? gameInfo.title : 'Playing Game';
        document.getElementById('current-page-title').innerHTML = `<span class="brand-gradient">Novellium</span> - ${gameTitle}`;
        
        showFeedback('Game loaded!');
      } catch (error) {
        console.error('Failed to load game:', error);
        showFeedback('Failed to load game', 'error');
        showStartScreen();
      }
    };

    // Load save file and start playing
    window.loadSaveAndPlay = async function(saveName) {
      try {
        showFeedback('Loading save...', 'info');
        
        // Get save data first to check game folder
        const saveData = saveManager.load(saveName);
        if (!saveData) {
          showFeedback('Save not found', 'error');
          return;
        }
        
        console.log('Loading save:', saveName, 'for game:', saveData.gameFolder);
        
        // Hide start screen first
        const startScreen = document.getElementById('start-screen');
        if (startScreen) {
          startScreen.style.display = 'none';
        }
        document.getElementById('slide-menu').classList.remove('active');
        
        // Create engine if needed or if different game
        if (!engine || currentGame !== saveData.gameFolder) {
          console.log('Creating new engine for:', saveData.gameFolder);
          engine = new VisualNovelEngine(document.getElementById('game-container'));
          currentGame = saveData.gameFolder;
        }
        
        // Load the save
        const success = await engine.loadSave(saveName);
        
        if (success) {
          showFeedback(`Loaded: ${saveName}`);
          
          // Update nav title to show current game
          const gameInfo = gamesList.games.find(g => g.folder === saveData.gameFolder);
          const gameTitle = gameInfo ? gameInfo.title : 'Playing Game';
          document.getElementById('current-page-title').innerHTML = `<span class="brand-gradient">Novellium</span> - ${gameTitle}`;
        } else {
          showFeedback('Failed to load save', 'error');
          showStartScreen();
        }
      } catch (error) {
        console.error('Error loading save:', error);
        showFeedback('Failed to load save', 'error');
        showStartScreen();
      }
    };

    // Delete save file
    window.deleteSave = function(saveName) {
      if (!engine) {
        engine = new VisualNovelEngine(document.getElementById('game-container'));
      }
      
      if (confirm(`Delete "${saveName}"?`)) {
        engine.saveManager.deleteSave(saveName);
        if (selectedGameForSaves) {
          loadMenuSavesForGame(selectedGameForSaves.folder);
        }
        showFeedback(`Deleted: ${saveName}`);
      }
    };

    // Show start screen
    function showStartScreen() {
      // Restore original navbar title
      document.getElementById('current-page-title').innerHTML = '<span class="brand-gradient">Novellium</span>';
      
      document.getElementById('game-container').innerHTML = `
        <div id="start-screen" class="start-screen">
          <!-- Left sidebar with game list -->
          <div class="games-sidebar" id="games-sidebar">
            <div class="sidebar-header">
              <h2>📚 Novellium Library</h2>
              <p class="library-subtitle">Unlimited Stories Await</p>
            </div>
            <div class="games-list-vertical" id="games-list-vertical">
              <!-- Games will be populated here -->
            </div>
          </div>
          
          <!-- Right content area -->
          <div class="content-area" id="content-area">
            <!-- Default welcome content -->
            <div class="welcome-content" id="welcome-content">
              <div class="hero-section">
                <h1 class="hero-title">Welcome to <span class="brand-gradient">Novellium</span></h1>
                <p class="hero-subtitle">Where Stories Come Alive</p>
              </div>

              <div class="platform-vision">
                <div class="vision-card player-card">
                  <div class="card-icon">🎮</div>
                  <h2>For Players</h2>
                  <p class="card-tagline">"Netflix for Visual Novels"</p>
                  <ul class="feature-list">
                    <li><strong>Instant Access</strong> - Click and play from a community made library</li>
                    <li><strong>Zero Setup</strong> - No downloads or installations required</li>
                    <li><strong>Local Saves</strong> - Your progress can be exported and imported as well as auto-backup</li>
                    <li><strong>Personalized</strong> - Customize themes and UI to your taste</li>
                    <li><strong>Unlimited Stories</strong> - One subscription, endless adventures</li>
                  </ul>
                </div>

                <div class="vision-card creator-card">
                  <div class="card-icon">📝</div>
                  <h2>For Creators</h2>
                  <p class="card-tagline">"WordPress for Interactive Stories"</p>
                  <ul class="feature-list">
                    <li><strong>Zero-Code</strong> - Write stories, not programs</li>
                    <li><strong>Instant Publishing</strong> - Deploy directly to the platform</li>
                    <li><strong>Professional Results</strong> - Rich features built-in automatically</li>
                    <li><strong>Creative Dump</strong> - Share your ideas without barriers</li>
                    <li><strong>Tap into the Audience</strong> - Access existing player base for free</li>
                  </ul>
                </div>
              </div>

              <div class="cta-section">
                <p class="cta-prompt">← Select a game to start playing</p>
                <p class="cta-prompt">Or <a href="build.html" class="inline-link">create your own story</a> →</p>
              </div>
            </div>
            
            <!-- Game options panel (shown when game selected) -->
            <div class="game-options-panel" id="game-options-panel" style="display: none;">
              <div class="game-options-header">
                <h2 id="selected-game-title">Game Title</h2>
                <p id="selected-game-author" style="color: #ffd700; font-size: 0.9em; margin: 5px 0 10px 0;">By Anonymous</p>
                <p id="selected-game-description">Game description</p>
              </div>
              <div class="game-options-content">
                <button id="btn-play-new" class="game-action-btn new-game">▶ Start New Game</button>
                
                <div class="saves-section">
                  <h3>💾 Load Saved Game</h3>
                  <div id="start-saves-list" class="saves-list-vertical">
                    <p class="no-saves">No saves available for this game</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('current-page-title').innerHTML = '<span class="brand-gradient">Novellium</span>';
      populateGamesCarousel();
      selectedGameOnStart = null;
      currentGame = null;
    }

    // Close menu handler
    document.getElementById('close-menu').onclick = () => {
      document.getElementById('slide-menu').classList.remove('active');
    };
    
    // Universal Settings functionality
    const defaultSettings = {
      masterVolume: 70,
      typewriterSpeed: 5,
      colors: {
        primary: '#ffd700',
        secondary: '#ff6b6b',
        background: '#1a1a2e',
        text: '#ffffff'
      }
    };
    
    // Load saved settings from localStorage
    function loadSettings() {
      const saved = localStorage.getItem('novellium_universal_settings');
      if (saved) {
        const settings = JSON.parse(saved);
        document.getElementById('master-volume').value = settings.masterVolume || defaultSettings.masterVolume;
        document.getElementById('typewriter-speed').value = settings.typewriterSpeed || defaultSettings.typewriterSpeed;
        document.getElementById('primary-color').value = settings.colors.primary || defaultSettings.colors.primary;
        document.getElementById('secondary-color').value = settings.colors.secondary || defaultSettings.colors.secondary;
        document.getElementById('background-color').value = settings.colors.background || defaultSettings.colors.background;
        document.getElementById('text-color').value = settings.colors.text || defaultSettings.colors.text;
        updateSettingsValues();
        applySettings(settings);
      } else {
        updateSettingsValues();
        applySettings(defaultSettings);
      }
    }
    
    // Update setting value displays
    function updateSettingsValues() {
      document.getElementById('master-volume-value').textContent = document.getElementById('master-volume').value + '%';
      document.getElementById('typewriter-speed-value').textContent = document.getElementById('typewriter-speed').value;
      document.getElementById('primary-preview').textContent = document.getElementById('primary-color').value;
      document.getElementById('secondary-preview').textContent = document.getElementById('secondary-color').value;
      document.getElementById('background-preview').textContent = document.getElementById('background-color').value;
      document.getElementById('text-preview').textContent = document.getElementById('text-color').value;
    }
    
    // Apply settings to both pages
    function applySettings(settings) {
      // Apply colors to CSS variables
      document.documentElement.style.setProperty('--primary-color', settings.colors.primary);
      document.documentElement.style.setProperty('--secondary-color', settings.colors.secondary);
      document.documentElement.style.setProperty('--background-color', settings.colors.background);
      document.documentElement.style.setProperty('--text-color', settings.colors.text);
      
      // Create dynamic CSS overrides for both pages
      let dynamicStyle = document.getElementById('dynamic-universal-theme');
      if (!dynamicStyle) {
        dynamicStyle = document.createElement('style');
        dynamicStyle.id = 'dynamic-universal-theme';
        document.head.appendChild(dynamicStyle);
      }
      
      dynamicStyle.textContent = `
        /* Universal theme overrides for both index and builder */
        .brand-gradient,
        .vertical-game-card.selected,
        .carousel-game-card.selected,
        .menu-header h3,
        .sidebar-header h2,
        .vertical-game-info h3,
        .welcome-content h1,
        .game-options-header h2,
        .saves-section h3,
        .settings-section h4,
        .section-header h2,
        .builder-nav li.active,
        .nav-btn.primary,
        h1, h2, h3, h4 {
          color: ${settings.colors.primary} !important;
        }
        
        .vertical-game-card.selected,
        .vertical-game-card:hover,
        .builder-nav li:hover,
        .builder-nav li.active,
        input:checked + .toggle-slider {
          border-color: ${settings.colors.primary} !important;
        }
        
        /* Button colors */
        .game-action-btn.new-game,
        .settings-btn.apply,
        .nav-btn.primary,
        .btn-primary {
          background: linear-gradient(135deg, ${settings.colors.primary}, ${settings.colors.secondary}) !important;
          color: ${settings.colors.background} !important;
        }
        
        .game-action-btn.new-game:hover,
        .settings-btn.apply:hover,
        .btn-primary:hover {
          box-shadow: 0 6px 20px ${settings.colors.primary}66 !important;
        }
        
        /* Background colors */
        body,
        .start-screen,
        .content-area,
        .builder-container,
        .slide-menu {
          background-color: ${settings.colors.background} !important;
        }
        
        /* Text colors */
        body,
        .content-area,
        .slide-menu,
        .builder-container {
          color: ${settings.colors.text} !important;
        }
        
        /* Brand gradient override */
        .brand-gradient {
          background: linear-gradient(45deg, ${settings.colors.primary}, ${settings.colors.secondary}) !important;
          -webkit-background-clip: text !important;
          -webkit-text-fill-color: transparent !important;
          background-clip: text !important;
        }
        
        /* Navbar highlighting */
        .nav-btn.primary {
          background: linear-gradient(135deg, ${settings.colors.primary}, ${settings.colors.secondary}) !important;
          color: ${settings.colors.background} !important;
          border-color: ${settings.colors.primary} !important;
        }
      `;
      
      // Save settings
      const settingsToSave = {
        masterVolume: settings.masterVolume,
        typewriterSpeed: settings.typewriterSpeed,
        colors: settings.colors
      };
      localStorage.setItem('novellium_universal_settings', JSON.stringify(settingsToSave));
    }
    
    // Collect current settings from form
    function getCurrentSettings() {
      return {
        masterVolume: parseInt(document.getElementById('master-volume').value),
        typewriterSpeed: parseInt(document.getElementById('typewriter-speed').value),
        colors: {
          primary: document.getElementById('primary-color').value,
          secondary: document.getElementById('secondary-color').value,
          background: document.getElementById('background-color').value,
          text: document.getElementById('text-color').value
        }
      };
    }
    
    // Export settings
    function exportSettings() {
      const settings = getCurrentSettings();
      const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'novellium-settings.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showFeedback('Settings exported successfully!');
    }
    
    // Import settings
    function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const settings = JSON.parse(e.target.result);
              document.getElementById('master-volume').value = settings.masterVolume || defaultSettings.masterVolume;
              document.getElementById('typewriter-speed').value = settings.typewriterSpeed || defaultSettings.typewriterSpeed;
              document.getElementById('primary-color').value = settings.colors.primary || defaultSettings.colors.primary;
              document.getElementById('secondary-color').value = settings.colors.secondary || defaultSettings.colors.secondary;
              document.getElementById('background-color').value = settings.colors.background || defaultSettings.colors.background;
              document.getElementById('text-color').value = settings.colors.text || defaultSettings.colors.text;
              updateSettingsValues();
              applySettings(settings);
              showFeedback('Settings imported successfully!');
            } catch (error) {
              showFeedback('Error importing settings: ' + error.message, 'error');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }
    
    // Reset settings
    function resetSettings() {
      if (confirm('Reset all settings to default values?')) {
        document.getElementById('master-volume').value = defaultSettings.masterVolume;
        document.getElementById('typewriter-speed').value = defaultSettings.typewriterSpeed;
        document.getElementById('primary-color').value = defaultSettings.colors.primary;
        document.getElementById('secondary-color').value = defaultSettings.colors.secondary;
        document.getElementById('background-color').value = defaultSettings.colors.background;
        document.getElementById('text-color').value = defaultSettings.colors.text;
        updateSettingsValues();
        applySettings(defaultSettings);
        showFeedback('Settings reset to defaults!');
      }
    }
    
    // Settings input event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Load settings on page load
      loadSettings();
      
      // Range input listeners
      document.getElementById('master-volume').addEventListener('input', updateSettingsValues);
      document.getElementById('typewriter-speed').addEventListener('input', updateSettingsValues);
      
      // Color input listeners
      document.getElementById('primary-color').addEventListener('input', updateSettingsValues);
      document.getElementById('secondary-color').addEventListener('input', updateSettingsValues);
      document.getElementById('background-color').addEventListener('input', updateSettingsValues);
      document.getElementById('text-color').addEventListener('input', updateSettingsValues);
      
      // Button listeners
      document.getElementById('btn-apply-settings').onclick = () => {
        const settings = getCurrentSettings();
        applySettings(settings);
        showFeedback('Settings applied!');
        document.getElementById('slide-menu').classList.remove('active');
      };
      
      document.getElementById('btn-export-settings').onclick = exportSettings;
      document.getElementById('btn-import-settings').onclick = importSettings;
      document.getElementById('btn-reset-settings').onclick = resetSettings;
      
      // Save management functionality
      document.getElementById('btn-export-saves').onclick = async () => {
        try {
          await saveManager.exportAllSaves();
          showFeedback('All saves exported successfully!');
        } catch (error) {
          console.error('Export failed:', error);
          showFeedback('Failed to export saves', 'error');
        }
      };

      document.getElementById('btn-import-saves').onclick = () => {
        document.getElementById('import-saves-input').click();
      };

      document.getElementById('import-saves-input').onchange = async (e) => {
        const files = e.target.files;
        if (!files.length) return;

        let imported = 0;
        let failed = 0;

        for (const file of files) {
          try {
            if (file.name.endsWith('.vnbackup')) {
              // Import bundle of saves
              const result = await saveManager.importAllSaves(file);
              imported += result.imported;
            } else if (file.name.endsWith('.vnsave')) {
              // Import single save
              await saveManager.importSaveFromFile(file);
              imported++;
            }
          } catch (error) {
            console.error('Import failed for', file.name, error);
            failed++;
          }
        }

        if (imported > 0) {
          showFeedback(`Imported ${imported} save(s)${failed > 0 ? `, ${failed} failed` : ''}`);
          // Refresh the current game's save list if a game is selected
          if (selectedGameOnStart) {
            loadStartSavesForGame(selectedGameOnStart.folder);
          }
        } else {
          showFeedback('No saves imported', 'error');
        }

        // Reset file input
        e.target.value = '';
      };
      
      document.getElementById('btn-documentation').onclick = () => {
        try {
          window.open('README.pdf', '_blank');
        } catch (error) {
          alert('Documentation PDF not found. Please ensure README.pdf is in the project directory.');
        }
      };
    });
    
    // Reset colors button
    // Setup auto-backup toggle
    const autoBackupToggle = document.getElementById('auto-backup-toggle');
    const autoBackupStatus = document.getElementById('auto-backup-status');
    
    if (autoBackupToggle && autoBackupStatus) {
      autoBackupToggle.checked = saveManager.autoBackup;
      autoBackupStatus.textContent = saveManager.autoBackup ? 'Enabled' : 'Disabled';
      
      autoBackupToggle.onchange = () => {
        saveManager.autoBackup = autoBackupToggle.checked;
        autoBackupStatus.textContent = saveManager.autoBackup ? 'Enabled' : 'Disabled';
        localStorage.setItem('vn_auto_backup', saveManager.autoBackup.toString());
        showFeedback(saveManager.autoBackup ? 'Auto-backup enabled' : 'Auto-backup disabled');
      };
    }

    // Navigation and page setup
    const savedAutoBackup = localStorage.getItem('vn_auto_backup');
    if (savedAutoBackup !== null) {
      const enabled = savedAutoBackup === 'true';
      document.getElementById('auto-backup-toggle').checked = enabled;
      saveManager.autoBackup = enabled;
      document.getElementById('auto-backup-status').textContent = enabled ? 'Enabled' : 'Disabled';
    }
    
    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('slide-menu');
      const menuBtn = document.getElementById('btn-menu');
      
      if (!menu.contains(event.target) && event.target !== menuBtn) {
        menu.classList.remove('active');
      }
    });

    // Debug helper - view all localStorage saves
    window.viewAllSaves = function() {
      console.log('=== ALL LOCALSTORAGE SAVES ===');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('vn_save_')) {
          const data = JSON.parse(localStorage.getItem(key));
          console.log(`Save: ${key.replace('vn_save_', '')}`);
          console.log('  - gameFolder:', data.gameFolder);
          console.log('  - timestamp:', new Date(data.timestamp).toLocaleString());
          console.log('  - full data:', data);
        }
      }
    };

    // Initialize application
    // Load navbar component
    async function loadNavbar() {
      try {
        const response = await fetch('scripts/navbar.html');
        const html = await response.text();
        document.getElementById('navbar-container').innerHTML = html;
        
        // Update page title dynamically - keep the gradient span
        const titleElement = document.getElementById('current-page-title');
        if (titleElement) {
          titleElement.innerHTML = '<span class="brand-gradient">Novellium</span>';
          titleElement.onclick = () => showStartScreen();
        }
        
        // Setup navigation handlers and button states
        const btnHome = document.getElementById('btn-home');
        const btnBuilder = document.getElementById('btn-builder');
        
        if (btnHome) {
          btnHome.classList.add('primary'); // Highlight Library button on index page
          // Simple click handler - always show start screen
          btnHome.onclick = (e) => {
            e.preventDefault();
            showStartScreen();
          };
        }
        
        if (btnBuilder) {
          btnBuilder.classList.remove('primary'); // Remove highlight from Builder button
        }
        
        const btnSave = document.getElementById('btn-save');
        if (btnSave && engine && currentGame) {
          btnSave.style.display = 'block';
          btnSave.onclick = async () => {
            if (engine && currentGame) {
              await engine.quickSave();
              showFeedback('Game saved!', 'success');
            }
          };
        }
        
        const btnMenu = document.getElementById('btn-menu');
        if (btnMenu) {
          btnMenu.onclick = () => {
            document.getElementById('slide-menu').classList.add('active');
          };
        }
      } catch (error) {
        console.error('Failed to load navbar:', error);
      }
    }

    async function initializeApp() {
      await loadNavbar(); // Load navbar first
      await loadGamesList(); // Wait for games to load first
      loadSettings(); // Load saved settings and theme colors
      showStartScreen(); // Then show start screen with games
      
      // Auto-run debug helper on load
      console.log('Type viewAllSaves() in console to see all saved games');
      viewAllSaves();
    }
    
    initializeApp();
  </script>
</body>
</html>
