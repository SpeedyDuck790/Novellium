<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Novellium</title>
  <link rel="stylesheet" href="styles.css?v=3.0">
  <style id="dynamic-theme">
    /* Dynamic theme colors applied via JavaScript */
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Navbar will be loaded here -->
    <div id="navbar-container"></div>
    
    <!-- Settings panel (right side) -->
    <div id="slide-menu" class="slide-menu">
      <div class="menu-header">
        <h3>‚öôÔ∏è Settings</h3>
        <button id="close-menu" class="close-btn">‚úï</button>
      </div>
      
      <!-- Settings content -->
      <div class="settings-content">
        <div class="settings-section">
          <h4>UI Colors</h4>
          
          <div class="setting-item">
            <label for="primary-color">Primary Color:</label>
            <input type="color" id="primary-color" value="#ffd700">
            <span class="color-preview" id="primary-preview">#ffd700</span>
          </div>
          
          <div class="setting-item">
            <label for="secondary-color">Secondary Color:</label>
            <input type="color" id="secondary-color" value="#ff6b6b">
            <span class="color-preview" id="secondary-preview">#ff6b6b</span>
          </div>
          
          <div class="setting-item">
            <label for="background-color">Background Color:</label>
            <input type="color" id="background-color" value="#1a1a2e">
            <span class="color-preview" id="background-preview">#1a1a2e</span>
          </div>
          
          <div class="setting-item">
            <label for="text-color">Text Color:</label>
            <input type="color" id="text-color" value="#ffffff">
            <span class="color-preview" id="text-preview">#ffffff</span>
          </div>
          
          <div class="setting-item">
            <label for="dialogue-bg-color">Dialogue Box Background:</label>
            <input type="color" id="dialogue-bg-color" value="#000000">
            <span class="color-preview" id="dialogue-bg-preview">#000000</span>
            <input type="range" id="dialogue-bg-opacity" min="0" max="100" value="80">
            <span class="opacity-label">Opacity: <span id="dialogue-opacity-value">80</span>%</span>
          </div>
          
          <div class="setting-item">
            <label for="button-color">Button Color:</label>
            <input type="color" id="button-color" value="#ffd700">
            <span class="color-preview" id="button-preview">#ffd700</span>
          </div>
          
          <div class="setting-item">
            <label for="button-hover-color">Button Hover Color:</label>
            <input type="color" id="button-hover-color" value="#ffed4e">
            <span class="color-preview" id="button-hover-preview">#ffed4e</span>
          </div>
        </div>
        
        <div class="settings-section">
          <h4>üíæ Save File Management</h4>
          
          <div class="setting-item">
            <label>Backup & Restore</label>
            <p class="setting-description">Export saves to your local device to prevent data loss when browser cache is cleared.</p>
            <div class="button-group">
              <button id="btn-export-all-saves" class="settings-btn export">üì• Export All Saves</button>
              <button id="btn-import-saves" class="settings-btn import">üì§ Import Saves</button>
            </div>
            <input type="file" id="import-saves-input" accept=".vnbackup,.vnsave" style="display: none;" multiple>
          </div>
          
          <div class="setting-item">
            <label>Auto-Backup</label>
            <p class="setting-description">Automatically download a backup file each time you save.</p>
            <label class="toggle-switch">
              <input type="checkbox" id="auto-backup-toggle" checked>
              <span class="toggle-slider"></span>
            </label>
            <span id="auto-backup-status" class="status-text">Enabled</span>
          </div>
        </div>
        
        <div class="settings-actions">
          <button id="btn-reset-colors" class="settings-btn reset">üîÑ Reset to Default</button>
          <button id="btn-apply-colors" class="settings-btn apply">‚úì Apply Colors</button>
        </div>
      </div>
    </div>
    
    <div id="feedback-toast" class="feedback-toast"></div>
    
    <div id="game-container" class="game-container">
      <!-- Start screen will be loaded by JavaScript -->
    </div>
  </div>

  <script type="module">
    import { VisualNovelEngine } from './src/engine.js?v=2.1';
    import { SaveManager } from './src/managers/SaveManager.js?v=2.1';

    let engine = null;
    let currentGame = null;
    let gamesList = [];
    let saveManager = new SaveManager(); // Create a shared save manager
    
    console.log('SaveManager loaded:', saveManager);
    console.log('SaveManager has exportAllSaves?', typeof saveManager.exportAllSaves);
    console.log('Auto-backup initial state:', saveManager.autoBackup);

    // Feedback system
    function showFeedback(message, type = 'success') {
      const toast = document.getElementById('feedback-toast');
      toast.textContent = message;
      toast.className = `feedback-toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load games list
    async function loadGamesList() {
      try {
        const response = await fetch(`./games-list.json?v=${Date.now()}`);
        gamesList = await response.json();
        
        // Merge with deployed games from localStorage
        const deployedGames = localStorage.getItem('vn_games_list');
        if (deployedGames) {
          try {
            const deployed = JSON.parse(deployedGames);
            if (Array.isArray(deployed) && deployed.length > 0) {
              // Add deployed games to the list
              gamesList.games = [...gamesList.games, ...deployed];
              console.log('Added', deployed.length, 'deployed games');
            }
          } catch (e) {
            console.error('Error parsing deployed games:', e);
          }
        }
        
        console.log('Games list loaded:', gamesList);
        populateGamesCarousel();
      } catch (error) {
        console.error('Failed to load games list:', error);
        showFeedback('Failed to load games list', 'error');
      }
    }

    // Populate games in vertical sidebar
    let selectedGameOnStart = null;
    
    function populateGamesCarousel() {
      const gamesListVertical = document.getElementById('games-list-vertical');
      
      if (!gamesListVertical) {
        console.error('games-list-vertical element not found');
        return;
      }
      
      if (!gamesList || !gamesList.games) {
        console.error('No games in gamesList:', gamesList);
        return;
      }
      
      gamesListVertical.innerHTML = '';
      
      console.log('Populating', gamesList.games.length, 'games');
      
      gamesList.games.forEach(game => {
        const gameCard = document.createElement('div');
        gameCard.className = 'vertical-game-card';
        gameCard.dataset.gameFolder = game.folder;
        gameCard.innerHTML = `
          <div class="vertical-game-thumbnail">
            <img src="${game.thumbnail}" alt="${game.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2210%22%3ENo Image%3C/text%3E%3C/svg%3E'">
          </div>
          <div class="vertical-game-info">
            <h3>${game.title}</h3>
            <p style="color: #ffd700; font-size: 0.85em; margin: 5px 0;">By ${game.author || 'Anonymous'}</p>
            <p>${game.description}</p>
          </div>
        `;
        
        // Click card to show game options
        gameCard.addEventListener('click', () => {
          selectGameOnStart(game);
        });
        
        gamesListVertical.appendChild(gameCard);
      });
    }

    // Select a game on start screen to show options
    function selectGameOnStart(game) {
      selectedGameOnStart = game;
      
      // Update card selection
      document.querySelectorAll('.vertical-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-game-folder="${game.folder}"]`).classList.add('selected');
      
      // Hide welcome content, show game options
      document.getElementById('welcome-content').style.display = 'none';
      const optionsPanel = document.getElementById('game-options-panel');
      optionsPanel.style.display = 'block';
      
      // Update game info
      document.getElementById('selected-game-title').textContent = game.title;
      const authorElement = document.getElementById('selected-game-author');
      if (authorElement) {
        authorElement.textContent = `By ${game.author || 'Anonymous'}`;
        authorElement.style.display = 'block';
      }
      document.getElementById('selected-game-description').textContent = game.description;
      
      // Setup play new button
      document.getElementById('btn-play-new').onclick = () => {
        loadGame(game.folder);
      };
      
      // Load saves for this game
      loadStartSavesForGame(game.folder);
    }

    // Load saves for game on start screen
    function loadStartSavesForGame(gameFolder) {
      console.log('=== loadStartSavesForGame called ===');
      console.log('GameFolder:', gameFolder);
      
      // Use the shared save manager instead of creating engine
      const allSaves = saveManager.getSaveSlots();
      console.log('All saves from localStorage:', allSaves);
      
      const gameSaves = allSaves.filter(save => {
        console.log(`Checking save: ${save.name}, folder: ${save.gameFolder} === ${gameFolder}?`, save.gameFolder === gameFolder);
        return save.gameFolder === gameFolder;
      });
      console.log('Filtered game saves:', gameSaves);
      
      const savesList = document.getElementById('start-saves-list');
      
      if (!savesList) {
        console.error('start-saves-list element not found!');
        return;
      }
      
      if (gameSaves.length === 0) {
        savesList.innerHTML = '<p class="no-saves">No saves for this game yet</p>';
        return;
      }
      
      savesList.innerHTML = '';
      gameSaves.forEach(save => {
        const item = document.createElement('div');
        item.className = 'start-save-item';
        const date = new Date(save.timestamp).toLocaleString();
        
        item.innerHTML = `
          <div class="save-info">
            <span class="save-name">${save.name}</span>
            <span class="save-date">${date}</span>
          </div>
          <div class="save-actions">
            <button onclick="loadSaveAndPlay('${save.name}')" class="load-save-btn">Load</button>
            <button onclick="deleteStartSave('${save.name}')" class="delete-save-btn">√ó</button>
          </div>
        `;
        savesList.appendChild(item);
      });
    }

    // Delete save from start screen
    window.deleteStartSave = function(saveName) {
      if (confirm(`Delete "${saveName}"?`)) {
        saveManager.deleteSave(saveName);
        if (selectedGameOnStart) {
          loadStartSavesForGame(selectedGameOnStart.folder);
        }
        showFeedback(`Deleted: ${saveName}`);
      }
    };

    // OLD - Close saves panel (not used with new vertical layout)
    /*
    document.getElementById('close-saves-panel').onclick = () => {
      document.getElementById('saves-panel').style.display = 'none';
      document.querySelectorAll('.carousel-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      selectedGameOnStart = null;
    };
    */

    // Populate menu games bar with cards
    let selectedGameForSaves = null;
    
    // OLD FUNCTION - Not used with new vertical layout
    /*
    function populateMenuGames() {
      const menuGamesBar = document.getElementById('menu-games-bar');
      menuGamesBar.innerHTML = '';
      
      gamesList.games.forEach(game => {
        const card = document.createElement('div');
        card.className = 'menu-game-card';
        card.dataset.gameFolder = game.folder;
        card.innerHTML = `
          <div class="menu-game-thumbnail">
            <img src="${game.thumbnail}" alt="${game.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'">
          </div>
          <div class="menu-game-info">
            <h5>${game.title}</h5>
            <button class="play-game-btn" onclick="loadGame('${game.folder}')">‚ñ∂ Play</button>
          </div>
        `;
        
        // Click card to show saves
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('play-game-btn')) {
            selectGameForSaves(game);
          }
        });
        
        menuGamesBar.appendChild(card);
      });
    }
    */

    // Select a game to view its saves
    // OLD FUNCTIONS - Not used with new vertical layout
    /*
    function selectGameForSaves(game) {
      selectedGameForSaves = game;
      
      // Update UI
      document.querySelectorAll('.menu-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-game-folder="${game.folder}"]`).classList.add('selected');
      
      // Show saves section
      document.getElementById('menu-saves-section').style.display = 'block';
      document.getElementById('selected-game-title').textContent = `${game.title} - Saves`;
      document.getElementById('btn-new-save').style.display = 'block';
      
      // Load saves for this game
      loadMenuSavesForGame(game.folder);
    }

    // Load and populate save files for specific game
    function loadMenuSavesForGame(gameFolder) {
      if (!engine) {
        engine = new VisualNovelEngine(document.getElementById('game-container'));
      }
      
      const allSaves = engine.saveManager.getSaveSlots();
      const gameSaves = allSaves.filter(save => save.gameFolder === gameFolder);
      const menuSavesList = document.getElementById('menu-saves-list');
      
      if (gameSaves.length === 0) {
        menuSavesList.innerHTML = '<p class="no-saves">No saves for this game yet</p>';
        return;
      }
      
      menuSavesList.innerHTML = '';
      gameSaves.forEach(save => {
        const item = document.createElement('div');
        item.className = 'save-item';
        const date = new Date(save.timestamp).toLocaleString();
        
        item.innerHTML = `
          <div class="save-info">
            <span class="save-name">${save.name}</span>
            <span class="save-date">${date}</span>
          </div>
          <div class="save-actions">
            <button onclick="loadSaveAndPlay('${save.name}')" class="load-save-btn">Load</button>
            <button onclick="deleteSave('${save.name}')" class="delete-save-btn">Delete</button>
          </div>
        `;
        menuSavesList.appendChild(item);
      });
    }
    */

    // Load a specific game
    window.loadGame = async function(gamePath) {
      try {
        showFeedback('Loading game...', 'info');
        
        // Hide start screen
        const startScreen = document.getElementById('start-screen');
        if (startScreen) {
          startScreen.style.display = 'none';
        }
        
        // Close menu
        document.getElementById('slide-menu').classList.remove('active');
        
        // Only create new engine if it doesn't exist or game changed
        if (!engine || currentGame !== gamePath) {
          engine = new VisualNovelEngine(document.getElementById('game-container'));
          currentGame = gamePath;
          await engine.loadGame(gamePath);
        }
        
        // Update nav title to show current game
        const gameInfo = gamesList.games.find(g => g.folder === gamePath);
        const gameTitle = gameInfo ? gameInfo.title : 'Playing Game';
        document.getElementById('current-page-title').innerHTML = `<span class="brand-gradient">Novellium</span> - ${gameTitle}`;
        
        showFeedback('Game loaded!');
      } catch (error) {
        console.error('Failed to load game:', error);
        showFeedback('Failed to load game', 'error');
        showStartScreen();
      }
    };

    // Load save file and start playing
    window.loadSaveAndPlay = async function(saveName) {
      try {
        showFeedback('Loading save...', 'info');
        
        // Get save data first to check game folder
        const saveData = saveManager.load(saveName);
        if (!saveData) {
          showFeedback('Save not found', 'error');
          return;
        }
        
        console.log('Loading save:', saveName, 'for game:', saveData.gameFolder);
        
        // Hide start screen first
        const startScreen = document.getElementById('start-screen');
        if (startScreen) {
          startScreen.style.display = 'none';
        }
        document.getElementById('slide-menu').classList.remove('active');
        
        // Create engine if needed or if different game
        if (!engine || currentGame !== saveData.gameFolder) {
          console.log('Creating new engine for:', saveData.gameFolder);
          engine = new VisualNovelEngine(document.getElementById('game-container'));
          currentGame = saveData.gameFolder;
        }
        
        // Load the save
        const success = await engine.loadSave(saveName);
        
        if (success) {
          showFeedback(`Loaded: ${saveName}`);
          
          // Update nav title to show current game
          const gameInfo = gamesList.games.find(g => g.folder === saveData.gameFolder);
          const gameTitle = gameInfo ? gameInfo.title : 'Playing Game';
          document.getElementById('current-page-title').innerHTML = `<span class="brand-gradient">Novellium</span> - ${gameTitle}`;
        } else {
          showFeedback('Failed to load save', 'error');
          showStartScreen();
        }
      } catch (error) {
        console.error('Error loading save:', error);
        showFeedback('Failed to load save', 'error');
        showStartScreen();
      }
    };

    // Delete save file
    window.deleteSave = function(saveName) {
      if (!engine) {
        engine = new VisualNovelEngine(document.getElementById('game-container'));
      }
      
      if (confirm(`Delete "${saveName}"?`)) {
        engine.saveManager.deleteSave(saveName);
        if (selectedGameForSaves) {
          loadMenuSavesForGame(selectedGameForSaves.folder);
        }
        showFeedback(`Deleted: ${saveName}`);
      }
    };

    // Show start screen
    function showStartScreen() {
      // Restore original navbar title
      document.getElementById('current-page-title').innerHTML = '<span class="brand-gradient">Novellium</span>';
      
      document.getElementById('game-container').innerHTML = `
        <div id="start-screen" class="start-screen">
          <!-- Left sidebar with game list -->
          <div class="games-sidebar" id="games-sidebar">
            <div class="sidebar-header">
              <h2>üìö Novellium Library</h2>
              <p class="library-subtitle">Unlimited Stories Await</p>
            </div>
            <div class="games-list-vertical" id="games-list-vertical">
              <!-- Games will be populated here -->
            </div>
          </div>
          
          <!-- Right content area -->
          <div class="content-area" id="content-area">
            <!-- Default welcome content -->
            <div class="welcome-content" id="welcome-content">
              <div class="hero-section">
                <h1 class="hero-title">Welcome to <span class="brand-gradient">Novellium</span></h1>
                <p class="hero-subtitle">Where Stories Come Alive</p>
              </div>

              <div class="platform-vision">
                <div class="vision-card player-card">
                  <div class="card-icon">üéÆ</div>
                  <h2>For Players</h2>
                  <p class="card-tagline">"Netflix for Visual Novels"</p>
                  <ul class="feature-list">
                    <li><strong>Instant Access</strong> - Click and play from a community made library</li>
                    <li><strong>Zero Setup</strong> - No downloads or installations required</li>
                    <li><strong>Local Saves</strong> - Your progress can be exported and imported as well as auto-backup</li>
                    <li><strong>Personalized</strong> - Customize themes and UI to your taste</li>
                    <li><strong>Unlimited Stories</strong> - One subscription, endless adventures</li>
                  </ul>
                </div>

                <div class="vision-card creator-card">
                  <div class="card-icon">üìù</div>
                  <h2>For Creators</h2>
                  <p class="card-tagline">"WordPress for Interactive Stories"</p>
                  <ul class="feature-list">
                    <li><strong>Zero-Code</strong> - Write stories, not programs</li>
                    <li><strong>Instant Publishing</strong> - Deploy directly to the platform</li>
                    <li><strong>Professional Results</strong> - Rich features built-in automatically</li>
                    <li><strong>Creative Dump</strong> - Share your ideas without barriers</li>
                    <li><strong>Tap into the Audience</strong> - Access existing player base for free</li>
                  </ul>
                </div>
              </div>

              <div class="cta-section">
                <p class="cta-prompt">‚Üê Select a game to start playing</p>
                <p class="cta-prompt">Or <a href="build.html" class="inline-link">create your own story</a> ‚Üí</p>
              </div>
            </div>
            
            <!-- Game options panel (shown when game selected) -->
            <div class="game-options-panel" id="game-options-panel" style="display: none;">
              <div class="game-options-header">
                <h2 id="selected-game-title">Game Title</h2>
                <p id="selected-game-author" style="color: #ffd700; font-size: 0.9em; margin: 5px 0 10px 0;">By Anonymous</p>
                <p id="selected-game-description">Game description</p>
              </div>
              <div class="game-options-content">
                <button id="btn-play-new" class="game-action-btn new-game">‚ñ∂ Start New Game</button>
                
                <div class="saves-section">
                  <h3>üíæ Load Saved Game</h3>
                  <div id="start-saves-list" class="saves-list-vertical">
                    <p class="no-saves">No saves available for this game</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('current-page-title').innerHTML = '<span class="brand-gradient">Novellium</span>';
      populateGamesCarousel();
      selectedGameOnStart = null;
      currentGame = null;
    }

    // Close menu handler
    document.getElementById('close-menu').onclick = () => {
      document.getElementById('slide-menu').classList.remove('active');
    };
    
    // Settings functionality
    const defaultColors = {
      primary: '#ffd700',
      secondary: '#ff6b6b',
      background: '#1a1a2e',
      text: '#ffffff',
      dialogueBg: '#000000',
      dialogueOpacity: 80,
      button: '#ffd700',
      buttonHover: '#ffed4e'
    };
    
    // Load saved colors from localStorage
    function loadColors() {
      const saved = localStorage.getItem('vn_theme_colors');
      if (saved) {
        const colors = JSON.parse(saved);
        document.getElementById('primary-color').value = colors.primary;
        document.getElementById('secondary-color').value = colors.secondary;
        document.getElementById('background-color').value = colors.background;
        document.getElementById('text-color').value = colors.text;
        document.getElementById('dialogue-bg-color').value = colors.dialogueBg;
        document.getElementById('dialogue-bg-opacity').value = colors.dialogueOpacity;
        document.getElementById('button-color').value = colors.button;
        document.getElementById('button-hover-color').value = colors.buttonHover;
        updateColorPreviews();
        applyColors(colors);
      }
    }
    
    // Update color preview labels
    function updateColorPreviews() {
      document.getElementById('primary-preview').textContent = document.getElementById('primary-color').value;
      document.getElementById('secondary-preview').textContent = document.getElementById('secondary-color').value;
      document.getElementById('background-preview').textContent = document.getElementById('background-color').value;
      document.getElementById('text-preview').textContent = document.getElementById('text-color').value;
      document.getElementById('dialogue-bg-preview').textContent = document.getElementById('dialogue-bg-color').value;
      document.getElementById('button-preview').textContent = document.getElementById('button-color').value;
      document.getElementById('button-hover-preview').textContent = document.getElementById('button-hover-color').value;
      document.getElementById('dialogue-opacity-value').textContent = document.getElementById('dialogue-bg-opacity').value;
    }
    
    // Apply colors to CSS variables AND dynamic style overrides
    function applyColors(colors) {
      // Set CSS variables
      document.documentElement.style.setProperty('--primary-color', colors.primary);
      document.documentElement.style.setProperty('--secondary-color', colors.secondary);
      document.documentElement.style.setProperty('--background-color', colors.background);
      document.documentElement.style.setProperty('--text-color', colors.text);
      document.documentElement.style.setProperty('--dialogue-bg-color', colors.dialogueBg);
      document.documentElement.style.setProperty('--dialogue-bg-opacity', colors.dialogueOpacity / 100);
      document.documentElement.style.setProperty('--button-color', colors.button);
      document.documentElement.style.setProperty('--button-hover-color', colors.buttonHover);
      
      // Create dynamic CSS overrides that target actual UI elements
      const dynamicStyle = document.getElementById('dynamic-theme');
      dynamicStyle.textContent = `
        /* Primary color overrides */
        .vertical-game-card.selected,
        .carousel-game-card.selected,
        .menu-header h3,
        .sidebar-header h2,
        .vertical-game-info h3,
        .welcome-content h1,
        .game-options-header h2,
        .saves-section h3,
        .settings-section h4,
        h1, h2, h3, h4 {
          color: ${colors.primary} !important;
        }
        
        .vertical-game-card.selected,
        .vertical-game-card:hover,
        input:checked + .toggle-slider {
          border-color: ${colors.primary} !important;
        }
        
        input:checked + .toggle-slider:before {
          background-color: ${colors.primary} !important;
        }
        
        /* Button colors */
        .game-action-btn.new-game,
        .settings-btn.apply,
        .nav-btn.primary {
          background: linear-gradient(135deg, ${colors.button}, ${colors.buttonHover}) !important;
        }
        
        .game-action-btn.new-game:hover,
        .settings-btn.apply:hover {
          box-shadow: 0 6px 20px ${colors.button}66 !important;
        }
        
        /* Secondary color overrides */
        .game-menu h1,
        .welcome-section h1 {
          background: linear-gradient(45deg, ${colors.primary}, ${colors.secondary}) !important;
          -webkit-background-clip: text !important;
          -webkit-text-fill-color: transparent !important;
          background-clip: text !important;
        }
        
        /* Background color */
        .start-screen,
        .content-area,
        .game-menu {
          background: linear-gradient(135deg, ${colors.background}, ${colors.background}dd) !important;
        }
        
        /* Text color */
        body,
        .app-container,
        .save-name,
        .vertical-game-card,
        .setting-item label {
          color: ${colors.text} !important;
        }
        
        /* Dialogue box */
        .dialogue-box {
          background-color: ${colors.dialogueBg} !important;
          opacity: ${colors.dialogueOpacity / 100} !important;
        }
      `;
    }
    
    // Color input change listeners
    document.querySelectorAll('input[type="color"], input[type="range"]').forEach(input => {
      input.addEventListener('input', updateColorPreviews);
    });
    
    // Apply colors button
    document.getElementById('btn-apply-colors').onclick = () => {
      const colors = {
        primary: document.getElementById('primary-color').value,
        secondary: document.getElementById('secondary-color').value,
        background: document.getElementById('background-color').value,
        text: document.getElementById('text-color').value,
        dialogueBg: document.getElementById('dialogue-bg-color').value,
        dialogueOpacity: parseInt(document.getElementById('dialogue-bg-opacity').value),
        button: document.getElementById('button-color').value,
        buttonHover: document.getElementById('button-hover-color').value
      };
      
      applyColors(colors);
      localStorage.setItem('vn_theme_colors', JSON.stringify(colors));
      showFeedback('Colors applied!');
      document.getElementById('slide-menu').classList.remove('active');
    };
    
    // Reset colors button
    document.getElementById('btn-reset-colors').onclick = () => {
      document.getElementById('primary-color').value = defaultColors.primary;
      document.getElementById('secondary-color').value = defaultColors.secondary;
      document.getElementById('background-color').value = defaultColors.background;
      document.getElementById('text-color').value = defaultColors.text;
      document.getElementById('dialogue-bg-color').value = defaultColors.dialogueBg;
      document.getElementById('dialogue-bg-opacity').value = defaultColors.dialogueOpacity;
      document.getElementById('button-color').value = defaultColors.button;
      document.getElementById('button-hover-color').value = defaultColors.buttonHover;
      updateColorPreviews();
      applyColors(defaultColors);
      localStorage.removeItem('vn_theme_colors');
      showFeedback('Reset to default colors');
    };
    
    // Save file management functionality
    document.getElementById('btn-export-all-saves').onclick = async () => {
      try {
        await saveManager.exportAllSaves();
        showFeedback('All saves exported successfully!');
      } catch (error) {
        console.error('Export failed:', error);
        showFeedback('Failed to export saves', 'error');
      }
    };

    document.getElementById('btn-import-saves').onclick = () => {
      document.getElementById('import-saves-input').click();
    };

    document.getElementById('import-saves-input').onchange = async (e) => {
      const files = e.target.files;
      if (!files.length) return;

      let imported = 0;
      let failed = 0;

      for (const file of files) {
        try {
          if (file.name.endsWith('.vnbackup')) {
            // Import bundle of saves
            const result = await saveManager.importAllSaves(file);
            imported += result.imported;
          } else if (file.name.endsWith('.vnsave')) {
            // Import single save
            await saveManager.importSaveFromFile(file);
            imported++;
          }
        } catch (error) {
          console.error('Import failed for', file.name, error);
          failed++;
        }
      }

      if (imported > 0) {
        showFeedback(`Imported ${imported} save(s)${failed > 0 ? `, ${failed} failed` : ''}`);
        // Refresh the current game's save list if a game is selected
        if (selectedGameOnStart) {
          loadStartSavesForGame(selectedGameOnStart.folder);
        }
      } else {
        showFeedback('No saves imported', 'error');
      }

      // Reset file input
      e.target.value = '';
    };

    // Auto-backup toggle
    document.getElementById('auto-backup-toggle').onchange = (e) => {
      saveManager.autoBackup = e.target.checked;
      document.getElementById('auto-backup-status').textContent = e.target.checked ? 'Enabled' : 'Disabled';
      localStorage.setItem('vn_auto_backup', e.target.checked);
      showFeedback(e.target.checked ? 'Auto-backup enabled' : 'Auto-backup disabled', 'info');
    };

    // Load auto-backup preference
    const savedAutoBackup = localStorage.getItem('vn_auto_backup');
    if (savedAutoBackup !== null) {
      const enabled = savedAutoBackup === 'true';
      document.getElementById('auto-backup-toggle').checked = enabled;
      saveManager.autoBackup = enabled;
      document.getElementById('auto-backup-status').textContent = enabled ? 'Enabled' : 'Disabled';
    }
    
    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('slide-menu');
      const menuBtn = document.getElementById('btn-menu');
      
      if (!menu.contains(event.target) && event.target !== menuBtn) {
        menu.classList.remove('active');
      }
    });

    // Check for missing saves on startup
    setTimeout(() => {
      try {
        if (saveManager && typeof saveManager.hasSaves === 'function' && !saveManager.hasSaves()) {
          // No saves in localStorage - offer to import
          const shouldImport = confirm('No saves found in browser storage. Would you like to import saves from your device?');
          if (shouldImport) {
            document.getElementById('btn-import-saves').click();
          }
        }
      } catch (error) {
        console.error('Error checking for saves:', error);
      }
    }, 1000); // Wait 1 second after page load

    // Debug helper - view all localStorage saves
    window.viewAllSaves = function() {
      console.log('=== ALL LOCALSTORAGE SAVES ===');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('vn_save_')) {
          const data = JSON.parse(localStorage.getItem(key));
          console.log(`Save: ${key.replace('vn_save_', '')}`);
          console.log('  - gameFolder:', data.gameFolder);
          console.log('  - timestamp:', new Date(data.timestamp).toLocaleString());
          console.log('  - full data:', data);
        }
      }
    };

    // Initialize application
    // Load navbar component
    async function loadNavbar() {
      try {
        const response = await fetch('navbar.html');
        const html = await response.text();
        document.getElementById('navbar-container').innerHTML = html;
        
        // Update page title dynamically - keep the gradient span
        const titleElement = document.getElementById('current-page-title');
        if (titleElement) {
          titleElement.innerHTML = '<span class="brand-gradient">Novellium</span>';
          titleElement.onclick = () => showStartScreen();
        }
        
        // Setup navigation handlers
        const btnHome = document.getElementById('btn-home');
        if (btnHome) {
          btnHome.onclick = () => showStartScreen();
        }
        
        const btnSave = document.getElementById('btn-save');
        if (btnSave && engine && currentGame) {
          btnSave.style.display = 'block';
          btnSave.onclick = async () => {
            if (engine && currentGame) {
              await engine.quickSave();
              showFeedback('Game saved!', 'success');
            }
          };
        }
        
        const btnMenu = document.getElementById('btn-menu');
        if (btnMenu) {
          btnMenu.onclick = () => {
            document.getElementById('slide-menu').classList.add('active');
          };
        }
      } catch (error) {
        console.error('Failed to load navbar:', error);
      }
    }

    async function initializeApp() {
      await loadNavbar(); // Load navbar first
      await loadGamesList(); // Wait for games to load first
      loadColors(); // Load saved theme colors
      showStartScreen(); // Then show start screen with games
      
      // Auto-run debug helper on load
      console.log('Type viewAllSaves() in console to see all saved games');
      viewAllSaves();
    }
    
    initializeApp();
  </script>
</body>
</html>
