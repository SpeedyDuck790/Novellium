<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Novel Engine</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <nav class="navbar">
      <div class="nav-left">
        <button id="btn-home" class="nav-btn primary">üè† Home</button>
      </div>
      <div class="nav-center">
        <h3 id="current-game-title">Visual Novel Engine</h3>
      </div>
      <div class="nav-right">
        <button id="btn-save" class="nav-btn">üíæ Save</button>
        <button id="btn-menu" class="nav-btn">‚öôÔ∏è Settings</button>
      </div>
    </nav>
    
    <!-- Settings panel (right side) -->
    <div id="slide-menu" class="slide-menu">
      <div class="menu-header">
        <h3>‚öôÔ∏è Settings</h3>
        <button id="close-menu" class="close-btn">‚úï</button>
      </div>
      
      <!-- Settings content -->
      <div class="settings-content">
        <div class="settings-section">
          <h4>UI Colors</h4>
          
          <div class="setting-item">
            <label for="primary-color">Primary Color:</label>
            <input type="color" id="primary-color" value="#ffd700">
            <span class="color-preview" id="primary-preview">#ffd700</span>
          </div>
          
          <div class="setting-item">
            <label for="secondary-color">Secondary Color:</label>
            <input type="color" id="secondary-color" value="#ff6b6b">
            <span class="color-preview" id="secondary-preview">#ff6b6b</span>
          </div>
          
          <div class="setting-item">
            <label for="background-color">Background Color:</label>
            <input type="color" id="background-color" value="#1a1a2e">
            <span class="color-preview" id="background-preview">#1a1a2e</span>
          </div>
          
          <div class="setting-item">
            <label for="text-color">Text Color:</label>
            <input type="color" id="text-color" value="#ffffff">
            <span class="color-preview" id="text-preview">#ffffff</span>
          </div>
          
          <div class="setting-item">
            <label for="dialogue-bg-color">Dialogue Box Background:</label>
            <input type="color" id="dialogue-bg-color" value="#000000">
            <span class="color-preview" id="dialogue-bg-preview">#000000</span>
            <input type="range" id="dialogue-bg-opacity" min="0" max="100" value="80">
            <span class="opacity-label">Opacity: <span id="dialogue-opacity-value">80</span>%</span>
          </div>
          
          <div class="setting-item">
            <label for="button-color">Button Color:</label>
            <input type="color" id="button-color" value="#ffd700">
            <span class="color-preview" id="button-preview">#ffd700</span>
          </div>
          
          <div class="setting-item">
            <label for="button-hover-color">Button Hover Color:</label>
            <input type="color" id="button-hover-color" value="#ffed4e">
            <span class="color-preview" id="button-hover-preview">#ffed4e</span>
          </div>
        </div>
        
        <div class="settings-actions">
          <button id="btn-reset-colors" class="settings-btn reset">üîÑ Reset to Default</button>
          <button id="btn-apply-colors" class="settings-btn apply">‚úì Apply Colors</button>
        </div>
      </div>
    </div>
    
    <div id="feedback-toast" class="feedback-toast"></div>
    
    <div id="game-container" class="game-container">
      <div id="start-screen" class="start-screen">
        <div class="welcome-section">
          <h1>Visual Novel Engine</h1>
          <p>Select a game to play or load a save</p>
        </div>
        
        <!-- Horizontal game cards -->
        <div class="games-carousel" id="games-carousel">
          <!-- Games will be populated here -->
        </div>
        
        <!-- Expandable saves panel -->
        <div class="saves-panel" id="saves-panel" style="display: none;">
          <div class="saves-panel-header">
            <h3 id="saves-panel-title">Select a game above</h3>
            <button id="close-saves-panel" class="close-panel-btn">‚úï</button>
          </div>
          <div class="saves-panel-content">
            <button id="btn-play-new" class="play-new-btn">‚ñ∂ Start New Game</button>
            <div class="saves-divider">
              <span>or load a save</span>
            </div>
            <div id="start-saves-list" class="start-saves-list">
              <p class="no-saves">No saves available</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { VisualNovelEngine } from './src/engine.js';
    import { SaveManager } from './src/managers/SaveManager.js';

    let engine = null;
    let currentGame = null;
    let gamesList = [];
    let saveManager = new SaveManager(); // Create a shared save manager

    // Feedback system
    function showFeedback(message, type = 'success') {
      const toast = document.getElementById('feedback-toast');
      toast.textContent = message;
      toast.className = `feedback-toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load games list
    async function loadGamesList() {
      try {
        const response = await fetch('./games-list.json');
        gamesList = await response.json();
        populateGamesCarousel();
        populateMenuGames();
      } catch (error) {
        console.error('Failed to load games list:', error);
        showFeedback('Failed to load games list', 'error');
      }
    }

    // Populate games carousel on start screen
    let selectedGameOnStart = null;
    
    function populateGamesCarousel() {
      const gamesCarousel = document.getElementById('games-carousel');
      gamesCarousel.innerHTML = '';
      
      gamesList.games.forEach(game => {
        const gameCard = document.createElement('div');
        gameCard.className = 'carousel-game-card';
        gameCard.dataset.gameFolder = game.folder;
        gameCard.innerHTML = `
          <div class="carousel-game-thumbnail">
            <img src="${game.thumbnail}" alt="${game.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22120%22%3E%3Crect fill=%22%23333%22 width=%22200%22 height=%22120%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
          </div>
          <div class="carousel-game-info">
            <h3>${game.title}</h3>
            <p>${game.description}</p>
          </div>
        `;
        
        // Click card to expand saves
        gameCard.addEventListener('click', () => {
          selectGameOnStart(game);
        });
        
        gamesCarousel.appendChild(gameCard);
      });
    }

    // Select a game on start screen to show saves
    function selectGameOnStart(game) {
      selectedGameOnStart = game;
      
      // Update card selection
      document.querySelectorAll('.carousel-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-game-folder="${game.folder}"]`).classList.add('selected');
      
      // Show saves panel
      const savesPanel = document.getElementById('saves-panel');
      savesPanel.style.display = 'block';
      document.getElementById('saves-panel-title').textContent = game.title;
      
      // Setup play new button
      document.getElementById('btn-play-new').onclick = () => {
        loadGame(game.folder);
      };
      
      // Load saves for this game
      loadStartSavesForGame(game.folder);
    }

    // Load saves for game on start screen
    function loadStartSavesForGame(gameFolder) {
      // Use the shared save manager instead of creating engine
      const allSaves = saveManager.getSaveSlots();
      console.log('All saves:', allSaves);
      console.log('Looking for saves with gameFolder:', gameFolder);
      
      const gameSaves = allSaves.filter(save => save.gameFolder === gameFolder);
      console.log('Filtered game saves:', gameSaves);
      
      const savesList = document.getElementById('start-saves-list');
      
      if (gameSaves.length === 0) {
        savesList.innerHTML = '<p class="no-saves">No saves for this game yet</p>';
        return;
      }
      
      savesList.innerHTML = '';
      gameSaves.forEach(save => {
        const item = document.createElement('div');
        item.className = 'start-save-item';
        const date = new Date(save.timestamp).toLocaleString();
        
        item.innerHTML = `
          <div class="save-info">
            <span class="save-name">${save.name}</span>
            <span class="save-date">${date}</span>
          </div>
          <div class="save-actions">
            <button onclick="loadSaveAndPlay('${save.name}')" class="load-save-btn">Load</button>
            <button onclick="deleteStartSave('${save.name}')" class="delete-save-btn">√ó</button>
          </div>
        `;
        savesList.appendChild(item);
      });
    }

    // Delete save from start screen
    window.deleteStartSave = function(saveName) {
      if (confirm(`Delete "${saveName}"?`)) {
        saveManager.deleteSave(saveName);
        if (selectedGameOnStart) {
          loadStartSavesForGame(selectedGameOnStart.folder);
        }
        showFeedback(`Deleted: ${saveName}`);
      }
    };

    // Close saves panel
    document.getElementById('close-saves-panel').onclick = () => {
      document.getElementById('saves-panel').style.display = 'none';
      document.querySelectorAll('.carousel-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      selectedGameOnStart = null;
    };

    // Populate menu games bar with cards
    let selectedGameForSaves = null;
    
    function populateMenuGames() {
      const menuGamesBar = document.getElementById('menu-games-bar');
      menuGamesBar.innerHTML = '';
      
      gamesList.games.forEach(game => {
        const card = document.createElement('div');
        card.className = 'menu-game-card';
        card.dataset.gameFolder = game.folder;
        card.innerHTML = `
          <div class="menu-game-thumbnail">
            <img src="${game.thumbnail}" alt="${game.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'">
          </div>
          <div class="menu-game-info">
            <h5>${game.title}</h5>
            <button class="play-game-btn" onclick="loadGame('${game.folder}')">‚ñ∂ Play</button>
          </div>
        `;
        
        // Click card to show saves
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('play-game-btn')) {
            selectGameForSaves(game);
          }
        });
        
        menuGamesBar.appendChild(card);
      });
    }

    // Select a game to view its saves
    function selectGameForSaves(game) {
      selectedGameForSaves = game;
      
      // Update UI
      document.querySelectorAll('.menu-game-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-game-folder="${game.folder}"]`).classList.add('selected');
      
      // Show saves section
      document.getElementById('menu-saves-section').style.display = 'block';
      document.getElementById('selected-game-title').textContent = `${game.title} - Saves`;
      document.getElementById('btn-new-save').style.display = 'block';
      
      // Load saves for this game
      loadMenuSavesForGame(game.folder);
    }

    // Load and populate save files for specific game
    function loadMenuSavesForGame(gameFolder) {
      if (!engine) {
        engine = new VisualNovelEngine(document.getElementById('game-container'));
      }
      
      const allSaves = engine.saveManager.getSaveSlots();
      const gameSaves = allSaves.filter(save => save.gameFolder === gameFolder);
      const menuSavesList = document.getElementById('menu-saves-list');
      
      if (gameSaves.length === 0) {
        menuSavesList.innerHTML = '<p class="no-saves">No saves for this game yet</p>';
        return;
      }
      
      menuSavesList.innerHTML = '';
      gameSaves.forEach(save => {
        const item = document.createElement('div');
        item.className = 'save-item';
        const date = new Date(save.timestamp).toLocaleString();
        
        item.innerHTML = `
          <div class="save-info">
            <span class="save-name">${save.name}</span>
            <span class="save-date">${date}</span>
          </div>
          <div class="save-actions">
            <button onclick="loadSaveAndPlay('${save.name}')" class="load-save-btn">Load</button>
            <button onclick="deleteSave('${save.name}')" class="delete-save-btn">Delete</button>
          </div>
        `;
        menuSavesList.appendChild(item);
      });
    }

    // Load a specific game
    window.loadGame = async function(gamePath) {
      try {
        showFeedback('Loading game...', 'info');
        
        // Hide start screen
        const startScreen = document.getElementById('start-screen');
        if (startScreen) {
          startScreen.style.display = 'none';
        }
        
        // Close menu
        document.getElementById('slide-menu').classList.remove('open');
        
        // Only create new engine if it doesn't exist or game changed
        if (!engine || currentGame !== gamePath) {
          engine = new VisualNovelEngine(document.getElementById('game-container'));
          currentGame = gamePath;
          await engine.loadGame(gamePath);
        }
        
        // Update nav title
        const gameInfo = gamesList.games.find(g => g.folder === gamePath);
        document.getElementById('current-game-title').textContent = gameInfo ? gameInfo.title : 'Playing Game';
        
        showFeedback('Game loaded!');
      } catch (error) {
        console.error('Failed to load game:', error);
        showFeedback('Failed to load game', 'error');
        showStartScreen();
      }
    };

    // Load save file and start playing
    window.loadSaveAndPlay = async function(saveName) {
      try {
        showFeedback('Loading save...', 'info');
        
        // Get save data first to check game folder
        const saveData = saveManager.load(saveName);
        if (!saveData) {
          showFeedback('Save not found', 'error');
          return;
        }
        
        console.log('Loading save:', saveName, 'for game:', saveData.gameFolder);
        
        // Hide start screen first
        const startScreen = document.getElementById('start-screen');
        if (startScreen) {
          startScreen.style.display = 'none';
        }
        document.getElementById('slide-menu').classList.remove('open');
        
        // Create engine if needed or if different game
        if (!engine || currentGame !== saveData.gameFolder) {
          console.log('Creating new engine for:', saveData.gameFolder);
          engine = new VisualNovelEngine(document.getElementById('game-container'));
          currentGame = saveData.gameFolder;
        }
        
        // Load the save
        const success = await engine.loadSave(saveName);
        
        if (success) {
          showFeedback(`Loaded: ${saveName}`);
          
          // Update nav title
          const gameInfo = gamesList.games.find(g => g.folder === saveData.gameFolder);
          document.getElementById('current-game-title').textContent = gameInfo ? gameInfo.title : 'Playing Game';
        } else {
          showFeedback('Failed to load save', 'error');
          showStartScreen();
        }
      } catch (error) {
        console.error('Error loading save:', error);
        showFeedback('Failed to load save', 'error');
        showStartScreen();
      }
    };

    // Delete save file
    window.deleteSave = function(saveName) {
      if (!engine) {
        engine = new VisualNovelEngine(document.getElementById('game-container'));
      }
      
      if (confirm(`Delete "${saveName}"?`)) {
        engine.saveManager.deleteSave(saveName);
        if (selectedGameForSaves) {
          loadMenuSavesForGame(selectedGameForSaves.folder);
        }
        showFeedback(`Deleted: ${saveName}`);
      }
    };

    // Show start screen
    function showStartScreen() {
      document.getElementById('game-container').innerHTML = `
        <div id="start-screen" class="start-screen">
          <div class="welcome-section">
            <h1>Visual Novel Engine</h1>
            <p>Select a game to play or load a save</p>
          </div>
          
          <!-- Horizontal game cards -->
          <div class="games-carousel" id="games-carousel">
            <!-- Games will be populated here -->
          </div>
          
          <!-- Expandable saves panel -->
          <div class="saves-panel" id="saves-panel" style="display: none;">
            <div class="saves-panel-header">
              <h3 id="saves-panel-title">Select a game above</h3>
              <button id="close-saves-panel" class="close-panel-btn">‚úï</button>
            </div>
            <div class="saves-panel-content">
              <button id="btn-play-new" class="play-new-btn">‚ñ∂ Start New Game</button>
              <div class="saves-divider">
                <span>or load a save</span>
              </div>
              <div id="start-saves-list" class="start-saves-list">
                <p class="no-saves">No saves available</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('current-game-title').textContent = 'Visual Novel Engine';
      populateGamesCarousel();
      
      // Re-attach close button listener
      document.getElementById('close-saves-panel').onclick = () => {
        document.getElementById('saves-panel').style.display = 'none';
        document.querySelectorAll('.carousel-game-card').forEach(card => {
          card.classList.remove('selected');
        });
        selectedGameOnStart = null;
      };
      
      currentGame = null;
    }

    // Navigation event handlers
    document.getElementById('btn-home').onclick = () => showStartScreen();
    
    document.getElementById('btn-save').onclick = () => {
      if (engine && currentGame) {
        const saveName = prompt('Save name:', `Save_${new Date().toLocaleDateString().replace(/\//g, '_')}`);
        if (saveName) {
          engine.saveGame(saveName);
          showFeedback(`Saved: ${saveName}`);
        }
      } else {
        showFeedback('No game to save', 'error');
      }
    };

    // Menu functionality
    document.getElementById('btn-menu').onclick = () => {
      document.getElementById('slide-menu').classList.toggle('open');
    };

    document.getElementById('close-menu').onclick = () => {
      document.getElementById('slide-menu').classList.remove('open');
    };
    
    // Settings functionality
    const defaultColors = {
      primary: '#ffd700',
      secondary: '#ff6b6b',
      background: '#1a1a2e',
      text: '#ffffff',
      dialogueBg: '#000000',
      dialogueOpacity: 80,
      button: '#ffd700',
      buttonHover: '#ffed4e'
    };
    
    // Load saved colors from localStorage
    function loadColors() {
      const saved = localStorage.getItem('vn_theme_colors');
      if (saved) {
        const colors = JSON.parse(saved);
        document.getElementById('primary-color').value = colors.primary;
        document.getElementById('secondary-color').value = colors.secondary;
        document.getElementById('background-color').value = colors.background;
        document.getElementById('text-color').value = colors.text;
        document.getElementById('dialogue-bg-color').value = colors.dialogueBg;
        document.getElementById('dialogue-bg-opacity').value = colors.dialogueOpacity;
        document.getElementById('button-color').value = colors.button;
        document.getElementById('button-hover-color').value = colors.buttonHover;
        updateColorPreviews();
        applyColors(colors);
      }
    }
    
    // Update color preview labels
    function updateColorPreviews() {
      document.getElementById('primary-preview').textContent = document.getElementById('primary-color').value;
      document.getElementById('secondary-preview').textContent = document.getElementById('secondary-color').value;
      document.getElementById('background-preview').textContent = document.getElementById('background-color').value;
      document.getElementById('text-preview').textContent = document.getElementById('text-color').value;
      document.getElementById('dialogue-bg-preview').textContent = document.getElementById('dialogue-bg-color').value;
      document.getElementById('button-preview').textContent = document.getElementById('button-color').value;
      document.getElementById('button-hover-preview').textContent = document.getElementById('button-hover-color').value;
      document.getElementById('dialogue-opacity-value').textContent = document.getElementById('dialogue-bg-opacity').value;
    }
    
    // Apply colors to CSS variables
    function applyColors(colors) {
      document.documentElement.style.setProperty('--primary-color', colors.primary);
      document.documentElement.style.setProperty('--secondary-color', colors.secondary);
      document.documentElement.style.setProperty('--background-color', colors.background);
      document.documentElement.style.setProperty('--text-color', colors.text);
      document.documentElement.style.setProperty('--dialogue-bg-color', colors.dialogueBg);
      document.documentElement.style.setProperty('--dialogue-bg-opacity', colors.dialogueOpacity / 100);
      document.documentElement.style.setProperty('--button-color', colors.button);
      document.documentElement.style.setProperty('--button-hover-color', colors.buttonHover);
    }
    
    // Color input change listeners
    document.querySelectorAll('input[type="color"], input[type="range"]').forEach(input => {
      input.addEventListener('input', updateColorPreviews);
    });
    
    // Apply colors button
    document.getElementById('btn-apply-colors').onclick = () => {
      const colors = {
        primary: document.getElementById('primary-color').value,
        secondary: document.getElementById('secondary-color').value,
        background: document.getElementById('background-color').value,
        text: document.getElementById('text-color').value,
        dialogueBg: document.getElementById('dialogue-bg-color').value,
        dialogueOpacity: parseInt(document.getElementById('dialogue-bg-opacity').value),
        button: document.getElementById('button-color').value,
        buttonHover: document.getElementById('button-hover-color').value
      };
      
      applyColors(colors);
      localStorage.setItem('vn_theme_colors', JSON.stringify(colors));
      showFeedback('Colors applied!');
      document.getElementById('slide-menu').classList.remove('open');
    };
    
    // Reset colors button
    document.getElementById('btn-reset-colors').onclick = () => {
      document.getElementById('primary-color').value = defaultColors.primary;
      document.getElementById('secondary-color').value = defaultColors.secondary;
      document.getElementById('background-color').value = defaultColors.background;
      document.getElementById('text-color').value = defaultColors.text;
      document.getElementById('dialogue-bg-color').value = defaultColors.dialogueBg;
      document.getElementById('dialogue-bg-opacity').value = defaultColors.dialogueOpacity;
      document.getElementById('button-color').value = defaultColors.button;
      document.getElementById('button-hover-color').value = defaultColors.buttonHover;
      updateColorPreviews();
      applyColors(defaultColors);
      localStorage.removeItem('vn_theme_colors');
      showFeedback('Reset to default colors');
    };
    
    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('slide-menu');
      const menuBtn = document.getElementById('btn-menu');
      
      if (!menu.contains(event.target) && event.target !== menuBtn) {
        menu.classList.remove('open');
      }
    });

    // Initialize application
    loadColors(); // Load saved theme colors
    loadGamesList();
  </script>
</body>
</html>